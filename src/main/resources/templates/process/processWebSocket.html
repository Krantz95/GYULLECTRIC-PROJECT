<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- ì„œë¸Œíƒ€ì´í‹€ -->
        <div class="subtitle_css">ê³µì • ëª¨ë‹ˆí„°ë§</div>

        <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ / ìƒˆë¡œê³ ì¹¨ ì‹œê°„ êµ¬í˜„ ì „ -->
        <div class="py-3 d-flex align-items-center gap-3">
            <button type="button" class="refreshTime_css" th:onclick="|location.href='@{/monitoring/list}'|">
                ìƒˆë¡œê³ ì¹¨
            </button>

        </div>

        <!-- ê³µì •ë³„ OK/NGìœ¨ (smì¼ë•ŒëŠ” ì°¨íŠ¸1ê°œì”© ë³´ì´ê²Œ)-->
        <p class="fw-bold">ê³µì •ë³„ OK/NGìœ¨</p>

        <div class="row p-3 justify-content-between">
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;"> <!-- smì—ì„œ ì°¨íŠ¸ í¬ê¸° ì„¤ì • -->
                    <p class="align-self-start">1ê³µì •</p>
                    <canvas id="myChart1" style="width: 100%; height: auto;"></canvas>
                    <div id="text1" class="pt-2"></div>
                </div>
            </div>

        <div class="col-lg-3 col-12 d-flex justify-content-center">
            <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;">
                <p class="align-self-start">2ê³µì •</p>
                <canvas id="myChart2" style="width: 100%; height: auto;"></canvas>
                <div id="text2" class="pt-2"></div>
            </div>
        </div>

        <div class="col-lg-3 col-12 d-flex justify-content-center">
            <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;">
                <p class="align-self-start">3ê³µì •</p>
                <canvas id="myChart3" style="width: 100%; height: auto;"></canvas>
                <div id="text3" class="pt-2"></div>
            </div>
        </div>
    </div>


    <!-- í…Œì´ë¸” -->
        <div class="d-flex justify-content-between align-items-center">
            <p class="fw-bold mb-0">ê³µì • ë¡œê·¸</p>
            <a href="/monitoring/product/list" class="refreshTime_css" style="text-decoration: none;">ì œí’ˆë¦¬ìŠ¤íŠ¸</a>
        </div>

        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>ì œí’ˆëª…</th>
                    <th>ë¡œíŠ¸ë„˜ë²„</th>
                    <th>ê³µì •No.</th>
                    <th>ê³µì •ìƒíƒœ</th>
                    <th>ê³µì •ìƒì„±ì¼</th>
                    <th>ì—ëŸ¬ì½”ë“œ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="processForm : ${processes}">
                    <td th:text="${processForm.productName}"></td>
                    <td th:text="${processForm.lotNumber}"></td>
                    <td th:text="${processForm.processStep}"></td>
                    <td th:text="${processForm.processResultStatus}"></td>
                    <td th:text="${#temporals.format(processForm.createAt,'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${processForm.errorCode}"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>
</th:block>
<script th:inline="javascript" layout:fragment="script">
    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì´ˆê¸°ê°’ (Thymeleaf)
    var ng1 = /*[[${ngCountByStep[1]?:0}]]*/0;
    var ok1 = /*[[${okCountByStep[1]?:0}]]*/0;

    var ng2 = /*[[${ngCountByStep[2]?:0}]]*/0;
    var ok2 = /*[[${okCountByStep[2]?:0}]]*/0;

    var ng3 = /*[[${ngCountByStep[3]?:0}]]*/0;
    var ok3 = /*[[${okCountByStep[3]?:0}]]*/0;

    // ì´ˆê¸° ok/ng ì¹´ìš´íŠ¸ë¥¼ ì „ì—­ìœ¼ë¡œ ê´€ë¦¬ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìœ„í•´)
    window.okCounts = {1: ok1, 2: ok2, 3: ok3};
    window.ngCounts = {1: ng1, 2: ng2, 3: ng3};

    // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì²˜ìŒì— ì°¨íŠ¸ ìƒì„±ìš©)
    function drawChart(ctx, ok, ng, textElementId) {
        const total = ok + ng;
        const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
        const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['OK', 'NG'],
                datasets: [{
                    label: 'ê³µì • ìƒíƒœ',
                    data: [ok, ng],
                    backgroundColor: ['#4CAF50', '#F44336'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '40%',
                plugins: {
                    legend: { display: false }
                }
            }
        });

        const textDiv = document.getElementById(textElementId);
        if (textDiv) {
            textDiv.innerHTML =
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #4CAF50; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold;  font-size: 15px">OK </span><span style="font-size: 15px">${ok}ê±´ / ${okPercent}%</span><br>` +
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #F44336; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold; font-size: 15px">NG </span><span style="font-size: 15px">${ng}ê±´ / ${ngPercent}%</span>`;
        }

        return chart;
    }

    // ì‹¤ì‹œê°„ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì°¨íŠ¸ ê°ì²´, ok/ng ìˆ˜, í…ìŠ¤íŠ¸ ID ë°›ì•„ì„œ ê°±ì‹ )
    function updateChart(chart, ok, ng, textElementId) {
        const total = ok + ng;
        const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
        const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

        chart.data.datasets[0].data = [ok, ng];
        chart.update();

        const textDiv = document.getElementById(textElementId);
        if (textDiv) {
            textDiv.innerHTML =
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #4CAF50; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold;  font-size: 15px">OK </span><span style="font-size: 15px">${ok}ê±´ / ${okPercent}%</span><br>` +
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #F44336; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold; font-size: 15px">NG </span><span style="font-size: 15px">${ng}ê±´ / ${ngPercent}%</span>`;
        }
    }

    // ì°¨íŠ¸ ìƒì„± (ì´ˆê¸° ë Œë”ë§)
    const chart1 = drawChart(document.getElementById('myChart1'), ok1, ng1, 'text1');
    const chart2 = drawChart(document.getElementById('myChart2'), ok2, ng2, 'text2');
    const chart3 = drawChart(document.getElementById('myChart3'), ok3, ng3, 'text3');

    // lotNumberë³„ step ìƒíƒœ ëˆ„ì  ì €ì¥
    const lotStepStatusMap = {};

    // ì›¹ì†Œì¼“ ì—°ê²° ë° ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
    const socket = new SockJS("/ws");
    const stomp = Stomp.over(socket);

    stomp.connect({}, () => {
        stomp.subscribe("/topic/process", (msg) => {
            const p = JSON.parse(msg.body);
            console.log("ì‹¤ì‹œê°„ ì²˜ë¦¬ë¨:", msg.body);

            const step = p.processStep;
            const status = p.processResultStatus;
            const lotNumber = p.lotNumber;

            // lotNumber base ì¶”ì¶œ
            const base = lotNumber.split("_").slice(0, 3).join("_");
            if (!lotStepStatusMap[base]) lotStepStatusMap[base] = {};
            lotStepStatusMap[base][step] = status;

            // ì‹¤ì‹œê°„ ok/ng ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            if (!window.okCounts[step]) window.okCounts[step] = 0;
            if (!window.ngCounts[step]) window.ngCounts[step] = 0;

            if (status === 'OK') window.okCounts[step]++;
            if (status === 'NG') window.ngCounts[step]++;

            // ê³µì •ë³„ ì¹´ìš´í„° í™”ë©´ ì—…ë°ì´íŠ¸ (ok/ng/total)
            const okSpan = document.querySelector(`#ok-${step}`);
            const ngSpan = document.querySelector(`#ng-${step}`);
            const totalSpan = document.querySelector(`#total-${step}`);

            if (okSpan) okSpan.textContent = window.okCounts[step];
            if (ngSpan) ngSpan.textContent = window.ngCounts[step];
            if (totalSpan) totalSpan.textContent = window.okCounts[step] + window.ngCounts[step];

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
            switch (step) {
                case 1:
                    updateChart(chart1, window.okCounts[1], window.ngCounts[1], 'text1');
                    break;
                case 2:
                    updateChart(chart2, window.okCounts[2], window.ngCounts[2], 'text2');
                    break;
                case 3:
                    updateChart(chart3, window.okCounts[3], window.ngCounts[3], 'text3');
                    break;
            }

            // ì‹¤ì‹œê°„ í…Œì´ë¸” í–‰ ì¶”ê°€
            const tbody = document.querySelector("table tbody");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.productName}</td>
                <td>${p.lotNumber}</td>
                <td>${p.processStep}</td>
                <td>${p.processResultStatus}</td>
                <td>${p.createAt || '-'}</td>
                <td>${p.errorCode || '-'}</td>
            `;
            if (tbody) {
                tbody.prepend(tr);
                // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ìœ ì§€
                if (tbody.children.length > 10) {
                    tbody.removeChild(tbody.lastChild);
                }
            }
        });
    });
</script>
<!-- ë„ë„›ì°¨íŠ¸ ê·¸ë¦¬ê¸° -->
<!--<script th:inline="javascript" layout:fragment="script">-->
<!--    -->
<!--    function drawChart(ctx, ok, ng, textElementId) {-->
<!--        const total = ok + ng;-->
<!--        const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;-->
<!--        const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;-->

<!--        const chart = new Chart(ctx, {-->
<!--            type: 'doughnut',-->
<!--            data: {-->
<!--                labels: ['OK', 'NG'],-->
<!--                datasets: [{-->
<!--                    label: 'ê³µì • ìƒíƒœ',-->
<!--                    data: [ok, ng],-->
<!--                    backgroundColor: ['#4CAF50', '#F44336'],-->
<!--                    borderWidth: 0-->
<!--                }]-->
<!--            },-->
<!--            options: {-->
<!--                responsive: true,-->
<!--                maintainAspectRatio: true,-->
<!--                cutout: '40%',-->
<!--                plugins: {-->
<!--                    legend: { display: false }-->
<!--                }-->
<!--            }-->
<!--        });-->


<!--        const textDiv = document.getElementById(textElementId);-->
<!--        if (textDiv) {-->
<!--            textDiv.innerHTML =-->
<!--                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #4CAF50; margin-right: 5px;"></span>`-->
<!--            + `<span style="font-weight:bold;  font-size: 15px">OK </span><span style="font-size: 15px">${ok}ê±´ / ${okPercent}%</span><br>` +-->
<!--                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #F44336; margin-right: 5px;"></span>` +-->
<!--                `<span style="font-weight:bold; font-size: 15px">NG </span><span style="font-size: 15px">${ng}ê±´ / ${ngPercent}%</span>`;-->

<!--        }-->
<!--        return chart; // ğŸ”¥ chart ê°ì²´ ë°˜í™˜-->
<!--    }-->
<!--    // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸-->
<!--    let chart1, chart2, chart3;-->
<!--    // ì°¨íŠ¸ìƒì„±-->
<!--    chart1 = drawChart(document.getElementById('myChart1'),ok1,ng1, 'text1');-->
<!--    chart2 = drawChart(document.getElementById('myChart2'),ok2,ng2, 'text2');-->
<!--    chart3 = drawChart(document.getElementById('myChart3'),ok3,ng3, 'text3');-->

<!--    // lotNumberë³„ step ìƒíƒœ ëˆ„ì  ì €ì¥-->
<!--    const lotStepStatusMap = {}; // { lotNumberBase: {1: "OK", 2: "OK", 3: "OK"} }-->

<!--    //ì›¹ì†Œì¼“, ìë™í™”ë©´ì—…ë°ì´íŠ¸-->
<!--    const socket = new SockJS("/ws");-->
<!--    const stomp = Stomp.over(socket);-->

<!--    stomp.connect({}, () => {-->
<!--        stomp.subscribe("/topic/process", (msg) => {-->
<!--            const p = JSON.parse(msg.body);-->
<!--            // ì—¬ê¸°ì„œ step, statusë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë™ì ìœ¼ë¡œ í™”ë©´ ì—…ë°ì´íŠ¸-->
<!--            console.log("ì‹¤ì‹œê°„ ì²˜ë¦¬ë¨:", msg.body);-->
<!--            // ì˜ˆ: document.querySelector("#chart").updateChart(p);-->
<!--            // {"lotNumber":"PINKTINT_6_010_01_20250516","step":1,"status":"OK","processDate":"2025-05-16T16:26:23.514135300","errorCode":"_","productName":"PINKTINT"}-->

<!--            // ê³µì •ë³„ ì¹´ìš´í„° ì—…ë°ì´íŠ¸-->
<!--            const step = p.processStep;-->
<!--            const status = p.processResultStatus;-->
<!--            const lotNumber = p.lotNumber;-->

<!--            // lotNumberì—ì„œ base ì¶”ì¶œ-->
<!--            const base = lotNumber.split("_").slice(0, 3).join("_");   //"PINKTINT_33_001"-->
<!--            console.log(base)-->
<!--            console.log(lotStepStatusMap[base])-->

<!--            if (!lotStepStatusMap[base]) lotStepStatusMap[base] = {};-->
<!--            lotStepStatusMap[base][step] = status;-->

<!--            // ì™„ì œí’ˆ íŒë³„: step1, 2, 3ì´ ëª¨ë‘ OKì¼ ë•Œë§Œ ì¹´ìš´íŒ…-->
<!--            const stepStatus = lotStepStatusMap[base];-->
<!--            const today = new Date().toISOString().split("T")[0];-->

<!--            if (-->
<!--                p.createAt &&-->
<!--                p.createAt.startsWith(today) &&-->
<!--                stepStatus[1] === "OK" &&-->
<!--                stepStatus[2] === "OK" &&-->
<!--                stepStatus[3] === "OK" &&-->
<!--                step === 3 // ë§ˆì§€ë§‰ ê³µì •ì—ì„œë§Œ ì²˜ë¦¬-->
<!--            ) {-->


<!--                const span = document.getElementById("productCount");-->
<!--                if (span) {-->
<!--                    span.textContent = parseInt(span.textContent || '0') + 1;-->
<!--                }-->
<!--            }-->


<!--            // ê³µì •ë³„ ì¹´ìš´í„° ë° í…Œì´ë¸”-->
<!--            const okSpan = document.querySelector(`#ok-${step}`);-->
<!--            const ngSpan = document.querySelector(`#ng-${step}`);-->
<!--            const totalSpan = document.querySelector(`#total-${step}`);-->

<!--            if (status === 'OK' && okSpan) okSpan.textContent = parseInt(okSpan.textContent || '0') + 1;-->
<!--            if (status === 'NG' && ngSpan) ngSpan.textContent = parseInt(ngSpan.textContent || '0') + 1;-->
<!--            if (totalSpan) totalSpan.textContent = parseInt(totalSpan.textContent || '0') + 1;-->

<!--            // í•´ë‹¹ step ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í˜¸ì¶œ-->
<!--            switch (step) {-->
<!--                case 1:-->
<!--                    updateChart(chart1, window.okCounts[1], window.ngCounts[1], 'text1');-->
<!--                    break;-->
<!--                case 2:-->
<!--                    updateChart(chart2, window.okCounts[2], window.ngCounts[2], 'text2');-->
<!--                    break;-->
<!--                case 3:-->
<!--                    updateChart(chart3, window.okCounts[3], window.ngCounts[3], 'text3');-->
<!--                    break;-->
<!--            }-->

<!--            const tbody = document.querySelector("table tbody");-->
<!--            const tr = document.createElement("tr");-->
<!--            tr.innerHTML = `-->
<!--    <td>${p.productName}</td>-->
<!--    <td>${p.lotNumber}</td>-->
<!--    <td>${p.processStep}</td>-->
<!--    <td>${p.processResultStatus}</td>-->
<!--    <td>${p.createAt || '-'}</td>-->
<!--    <td>${p.errorCode}</td>-->
<!--`;-->
<!--            tbody.prepend(tr);-->
<!--        });-->
<!--    });-->
<!--</script>-->

</html>