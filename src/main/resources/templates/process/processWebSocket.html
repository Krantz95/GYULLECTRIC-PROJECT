<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- ì„œë¸Œíƒ€ì´í‹€ -->
        <div class="subtitle_css"><i class="bi bi-graph-up"></i> ê³µì • ëª¨ë‹ˆí„°ë§</div>

        <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ / ìƒˆë¡œê³ ì¹¨ ì‹œê°„ êµ¬í˜„ ì „ -->
        <div class="py-3 d-flex align-items-center gap-3">
            <button type="button" class="refreshTime_css" th:onclick="|location.href='@{/monitoring/list}'|">
                ìƒˆë¡œê³ ì¹¨
            </button>
            <div id="alert-bar" style="display:none; background-color: red; color: white; padding: 10px; font-weight: bold; text-align: center;"></div>
        </div>

        <!-- ê³µì •ë³„ OK/NGìœ¨ (smì¼ë•ŒëŠ” ì°¨íŠ¸1ê°œì”© ë³´ì´ê²Œ)-->
        <p class="fw-bold">ê³µì •ë³„ OK/NGìœ¨</p>

        <div class="row p-3 justify-content-around">
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;"> <!-- smì—ì„œ ì°¨íŠ¸ í¬ê¸° ì„¤ì • -->
                    <p class="align-self-start">1ê³µì • : í”„ë ˆì„</p>
                    <canvas id="myChart1" style="width: 100%; height: auto;"></canvas>
                    <div id="text1" class="pt-2"></div>
                </div>
            </div>

        <div class="col-lg-3 col-12 d-flex justify-content-center">
            <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;">
                <p class="align-self-start">2ê³µì • : ë„ì¥</p>
                <canvas id="myChart2" style="width: 100%; height: auto;"></canvas>
                <div id="text2" class="pt-2"></div>
            </div>
        </div>

        <div class="col-lg-3 col-12 d-flex justify-content-center">
            <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;">
                <p class="align-self-start">3ê³µì • : ê²€ìˆ˜</p>
                <canvas id="myChart3" style="width: 100%; height: auto;"></canvas>
                <div id="text3" class="pt-2"></div>
            </div>
        </div>
    </div>


    <!-- í…Œì´ë¸” -->
        <div class="d-flex justify-content-between align-items-center">
            <p class="fw-bold mb-0">ê³µì • ë¡œê·¸</p>
            <a href="/monitoring/product/list" class="refreshTime_css" style="text-decoration: none;">ì œí’ˆë¦¬ìŠ¤íŠ¸</a>
        </div>

        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>ì œí’ˆëª…</th>
                    <th>ë¡œíŠ¸ë„˜ë²„</th>
                    <th>ê³µì •No.</th>
                    <th>ê³µì •ìƒíƒœ</th>
                    <th>ê³µì •ìƒì„±ì¼</th>
                    <th>ì—ëŸ¬ì½”ë“œ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="processForm : ${processes}">
                    <td th:text="${processForm.productName}"></td>
                    <td th:text="${processForm.lotNumber}"></td>
                    <td th:text="${processForm.processStep}"></td>
                    <td th:text="${processForm.processResultStatus}"></td>
                    <td th:text="${#temporals.format(processForm.createAt,'yyyy-MM-dd HH:mm')}"></td>
                    <td style="color: darkred;">
                        <a th:if="${processForm.errorCode == 'EXCEPTION_ERROR'}" class="fw-bold"
                           th:href="@{/errors/report/form/{id}(id=${processForm.id})}"
                           style="cursor:pointer; color: darkred; text-decoration: underline;"
                           th:text="${processForm.errorCode}"></a>

                        <span th:unless="${processForm.errorCode == 'EXCEPTION_ERROR'}" th:text="${processForm.errorCode}"></span>
                        <span th:unless="${processForm.errorCode == 'EXCEPTION_ERROR'}" th:text="${processForm.errorDescription}"></span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>
</th:block>
<script th:inline="javascript" layout:fragment="script">
    // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ì´ˆê¸°ê°’ (Thymeleaf)
    var ng1 = /*[[${ngCountByStep[1]?:0}]]*/0;
    var ok1 = /*[[${okCountByStep[1]?:0}]]*/0;

    var ng2 = /*[[${ngCountByStep[2]?:0}]]*/0;
    var ok2 = /*[[${okCountByStep[2]?:0}]]*/0;

    var ng3 = /*[[${ngCountByStep[3]?:0}]]*/0;
    var ok3 = /*[[${okCountByStep[3]?:0}]]*/0;

    // ì´ˆê¸° ok/ng ì¹´ìš´íŠ¸ë¥¼ ì „ì—­ìœ¼ë¡œ ê´€ë¦¬ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ìœ„í•´)
    window.okCounts = {1: ok1, 2: ok2, 3: ok3};
    window.ngCounts = {1: ng1, 2: ng2, 3: ng3};

    const centerTextPlugin = {
        id: 'centerTextPlugin',
        beforeDraw: (chart) => {
            const {width, height, ctx} = chart;
            const dataset = chart.data.datasets[0];
            const total = dataset.data.reduce((a, b) => a + b, 0);
            const ok = dataset.data[0];
            const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;

            const centerX = width / 2;
            const centerY = height / 2;

            // â­• Draw orange circle
            const innerRadius = chart._metasets[0].data[0].innerRadius;
            ctx.save();
            ctx.beginPath();
            ctx.strokeStyle = 'orange';
            ctx.lineWidth = 4;
            ctx.arc(centerX, centerY, innerRadius - 5, 0, 2 * Math.PI); // -5 to fit inside nicely
            ctx.stroke();
            ctx.closePath();
            ctx.restore();

            // ğŸ”¢ Draw center percentage text
            ctx.save();
            ctx.font = 'bold 20px sans-serif';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${okPercent}%`, centerX, centerY);
            ctx.restore();
        }
    };

    Chart.register(centerTextPlugin);

    // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì²˜ìŒì— ì°¨íŠ¸ ìƒì„±ìš©)
    function drawChart(ctx, ok, ng, textElementId,  okLabel, ngLabel) {
        const total = ok + ng;
        const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
        const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['OK', 'NG'],
                datasets: [{
                    label: 'ê³µì • ìƒíƒœ',
                    data: [ok, ng],
                    backgroundColor:  ['#009913', '#ea2402'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '40%',
                plugins: {
                    legend: { display: false }
                }
            },
            plugins: [centerTextPlugin]
        });

        const textDiv = document.getElementById(textElementId);
        if (textDiv) {
            textDiv.innerHTML =
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #009913; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold;  font-size: 15px">${okLabel} </span><span style="font-size: 15px">${ok}ê±´ / ${okPercent}%</span><br>` +
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #ea2402; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold; font-size: 15px">${ngLabel} </span><span style="font-size: 15px">${ng}ê±´ / ${ngPercent}%</span>`;
        }

        return chart;
    }

    // ì‹¤ì‹œê°„ ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ì°¨íŠ¸ ê°ì²´, ok/ng ìˆ˜, í…ìŠ¤íŠ¸ ID ë°›ì•„ì„œ ê°±ì‹ )
    function updateChart(chart, ok, ng, textElementId,  okLabel, ngLabel) {
        const total = ok + ng;
        const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
        const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

        chart.data.datasets[0].data = [ok, ng];
        chart.update();

        const textDiv = document.getElementById(textElementId);
        if (textDiv) {
            textDiv.innerHTML =
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #009913; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold;  font-size: 15px">${okLabel} </span><span style="font-size: 15px">${ok}ê±´ / ${okPercent}%</span><br>` +
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #ea2402; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold; font-size: 15px">${ngLabel} </span><span style="font-size: 15px">${ng}ê±´ / ${ngPercent}%</span>`;
        }
    }

    window.chart1 = drawChart(document.getElementById('myChart1'), ok1, ng1, 'text1',  'ìš©ì ‘ ì¶œë ¥ í†µê³¼', 'ìš©ì ‘ ì¶œë ¥ ì´ìƒ');
    window.chart2 = drawChart(document.getElementById('myChart2'), ok2, ng2, 'text2', 'ë„ì¥ ì˜¨ë„ ì •ìƒ', 'ë„ì¥ ì˜¨ë„ ì´ìƒ');
    window.chart3 = drawChart(document.getElementById('myChart3'), ok3, ng3, 'text3',  'ê²€ìˆ˜ í†µê³¼', 'ê²€ìˆ˜ ë¶ˆëŸ‰');


    // lotNumberë³„ step ìƒíƒœ ëˆ„ì  ì €ì¥
    const lotStepStatusMap = {};

    // ì›¹ì†Œì¼“ ì—°ê²° ë° ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹ 
    const socket = new SockJS("/ws");
    const stomp = Stomp.over(socket);

    stomp.connect({}, () => {
        stomp.subscribe("/topic/process", (msg) => {
            const p = JSON.parse(msg.body);
            console.log("ì‹¤ì‹œê°„ ì²˜ë¦¬ë¨:", msg.body);

            const step = p.processStep;
            const status = p.processResultStatus;
            const lotNumber = p.lotNumber;

            // lotNumber base ì¶”ì¶œ
            const base = lotNumber.split("_").slice(0, 3).join("_");
            if (!lotStepStatusMap[base]) lotStepStatusMap[base] = {};
            lotStepStatusMap[base][step] = status;

            // ì‹¤ì‹œê°„ ok/ng ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            if (!window.okCounts[step]) window.okCounts[step] = 0;
            if (!window.ngCounts[step]) window.ngCounts[step] = 0;

            if (status === 'OK') window.okCounts[step]++;
            if (status === 'NG') window.ngCounts[step]++;

            // ê³µì •ë³„ ì¹´ìš´í„° í™”ë©´ ì—…ë°ì´íŠ¸ (ok/ng/total)
            const okSpan = document.querySelector(`#ok-${step}`);
            const ngSpan = document.querySelector(`#ng-${step}`);
            const totalSpan = document.querySelector(`#total-${step}`);

            if (okSpan) okSpan.textContent = window.okCounts[step];
            if (ngSpan) ngSpan.textContent = window.ngCounts[step];
            if (totalSpan) totalSpan.textContent = window.okCounts[step] + window.ngCounts[step];

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í˜¸ì¶œ
            switch (Number(step)) {
                case 1:
                    updateChart(window.chart1, window.okCounts[1], window.ngCounts[1], 'text1', 'ìš©ì ‘ ì¶œë ¥ í†µê³¼', 'ìš©ì ‘ ì¶œë ¥ ì´ìƒ');
                    break;
                case 2:
                    updateChart(window.chart2, window.okCounts[2], window.ngCounts[2], 'text2', 'ë„ì¥ ì˜¨ë„ ì •ìƒ', 'ë„ì¥ ì˜¨ë„ ì´ìƒ');
                    break;
                case 3:
                    updateChart(window.chart3, window.okCounts[3], window.ngCounts[3], 'text3', 'ê²€ìˆ˜ í†µê³¼', 'ê²€ìˆ˜ ë¶ˆëŸ‰');
                    break;
            }
            function getErrorDescription(errorCode, value) {
                switch(errorCode) {
                    case "ERROR_101":
                        return `ERROR_101_ìš©ì ‘ ì¶œë ¥ ê³¼ë‹¤ (${value.toFixed(1)}V)`;
                    case "ERROR_102":
                        return `ERROR_102_ìš©ì ‘ ì¶œë ¥ ë¶€ì¡± (${value.toFixed(1)}V)`;
                    case "ERROR_201":
                        return `ERROR_201_ì˜¨ë„ ì´ìƒ (${value.toFixed(1)}â„ƒ)`;
                    case "ERROR_202":
                        return `ERROR_202_ì˜¨ë„ ì´í•˜ (${value.toFixed(1)}â„ƒ)`;
                    case "ERROR_103":
                        return "ERROR_103_ìŠ¤í¬ë˜ì¹˜ ë¶ˆëŸ‰";
                    case "ERROR_110":
                        return "ERROR_110_ì¡°ë¦½ ë¶ˆëŸ‰";
                    case "ERROR_111":
                        return "ERROR_111_ê¸°ëŠ¥ ë¶ˆëŸ‰";
                    default:
                        return "EXCEPTION_ERROR";
                }
            }
            // ì‹¤ì‹œê°„ í…Œì´ë¸” í–‰ ì¶”ê°€
            const tbody = document.querySelector("table tbody");
            const tr = document.createElement("tr");

            const errorColor = '#8B0000';

            const errorCode = p.errorCode || '-';
            const errorValue = p.errorValue != null ? p.errorValue : null;

            let errorDisplay  = '_';

            if (errorCode && errorCode !== '_') {
                if (errorValue !== null && errorValue !== undefined) {
                    errorDisplay = getErrorDescription(errorCode, errorValue);
                } else {
                    // ê°’ì´ ì—†ì„ ê²½ìš°ì—ë„ description ë°˜í™˜í•˜ë„ë¡ ì²˜ë¦¬
                    errorDisplay = getErrorDescription(errorCode, 0); // or null
                }
            }


            tr.innerHTML = `
                <td>${p.productName}</td>
                <td>${p.lotNumber}</td>
                <td>${p.processStep}</td>
                <td>${p.processResultStatus}</td>
                <td>${p.createAt || '-'}</td>
                <td style="color: ${errorColor};">${errorDisplay}</td>
            `;
            if (tbody) {
                tbody.prepend(tr);
                // ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ ìœ ì§€
                if (tbody.children.length > 10) {
                    tbody.removeChild(tbody.lastChild);
                }
            }
        });
    });
</script>
</html>