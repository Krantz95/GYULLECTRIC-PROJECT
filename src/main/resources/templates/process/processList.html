<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css">공정 모니터링</div>

        <!-- 새로고침 버튼 / 새로고침 시간 구현 전 -->
        <div class="py-3 d-flex align-items-center gap-3">
            <button type="button" class="refreshTime_css" onclick="location.reload();">
                새로고침
            </button>
            <span>최근 업데이트: (시간 구현 전) 웹소캣으로 5초 업데이트하면 필요없나?  </span>
        </div>

        <!-- 공정별 OK/NG율 (sm일때는 차트1개씩 보이게)-->
        <p class="fw-bold">공정별 OK/NG율</p>

        <div class="row p-3 justify-content-between">
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center" style="width: 80%; max-width: 500px;"> <!-- sm에서 차트 크기 설정 -->
                <p class="align-self-start">1공정</p>
                <canvas id="myChart1" style="width: 100%; height: auto;"></canvas>
                <div id="chartText1" class="pt-2"></div>
                </div>
            </div>
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center" style="width: 80%; max-width: 500px;">
                <p class="align-self-start">2공정</p>
                <canvas id="myChart2" style="width: 100%; height: auto;"></canvas>
                <div id="chartText2" class="pt-2"></div>
                </div>
            </div>
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center" style="width: 80%; max-width: 500px;">
                <p class="align-self-start">3공정</p>
                <canvas id="myChart3" style="width: 100%; height: auto;"></canvas>
                <div id="chartText3" class="pt-2"></div>
                </div>
            </div>
        </div>


        <!-- 테이블 -->
        <div class="d-flex justify-content-between align-items-center">
            <p class="fw-bold mb-0">공정 로그</p>
            <a href="/productList" class="refreshTime_css" style="text-decoration: none;">제품리스트</a>
        </div>

        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>제품명</th>
                    <th>로트넘버</th>
                    <th>공정No.</th>
                    <th>공정상태</th>
                    <th>공정생성일</th>
                    <th>에러코드</th>
                </tr>
                </thead>
                <tbody>
                <!--                    <tr th:each="process : ${processes}">-->
                <!--                        <td th:text="${process.jobOrder.productName}"></td>-->
                <!--                        <td th:text="${process.lotNumber}"></td>-->
                <!--                        <td th:text="${process.step}"></td>-->
                <!--                        <td th:text="${process.status}"></td>-->
                <!--                        <td th:text="${#temporals.format(process.processDate,'yyyy-MM-dd hh-mm')}"></td>-->
                <!--                        <td th:text="${process.errorㅋCode}"></td>-->
                <!--                    </tr>-->
                <tr>
                    <td>A타입</td>
                    <td>LOT123</td>
                    <td>1공정</td>
                    <td>OK</td>
                    <td>2025-05-12 08:10</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>A타입</td>
                    <td>LOT124</td>
                    <td>2공정</td>
                    <td>NG</td>
                    <td>2025-05-12 08:20</td>
                    <td>204</td>
                </tr>
                <tr>
                    <td>B타입</td>
                    <td>LOT125</td>
                    <td>3공정</td>
                    <td>OK</td>
                    <td>2025-05-12 08:30</td>
                    <td>-</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>


    <!-- 주석 참고 // 임시 구현 파이차트 -->
    <script th:inline="javascript" layout:fragment="script">
        function drawChart(ctx, ok, ng, textElementId) {
            const total = ok + ng;
            const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
            const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['OK', 'NG'],
                    datasets: [{
                        data: [ok, ng],
                        backgroundColor: ['#4CAF50', '#F44336'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, // 차트 반응형
                    maintainAspectRatio: true, // 비율 유지하여 캔버스가 너무 커지지 않도록
                    cutout: '40%', // 파이차트 내부 원 크기 줄이기
                    plugins: {
                        legend: { display: false } // 범례 숨기기
                    }
                }
            });

            // 퍼센트/수치 범례 : 폰트사이즈 13 -> 15로 변경 (13너무 작음)
            const textDiv = document.getElementById(textElementId);
            textDiv.innerHTML =
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #4CAF50; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold; font-size: 15px">OK </span><span style="font-size: 15px">${ok}건 / ${okPercent}%</span><br>` +
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #F44336; margin-right: 5px;"></span>` +
                `<span style="font-weight:bold; font-size: 15px">NG </span><span style="font-size: 15px">${ng}건 / ${ngPercent}%</span>`; // css로 안넣고 인라인처리
        }

        // ↓ 이 값들도 나중에 서버에서 Thymeleaf 방식으로 변경
        document.addEventListener('DOMContentLoaded', function () {
            drawChart(document.getElementById('myChart1'), 70, 30, 'chartText1');
            drawChart(document.getElementById('myChart2'), 30, 70, 'chartText2');
            drawChart(document.getElementById('myChart3'), 45, 55, 'chartText3');
        });
    </script>
</th:block>
</html>