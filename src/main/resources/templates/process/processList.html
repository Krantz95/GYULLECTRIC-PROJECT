<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css">공정 모니터링</div>

        <!-- 새로고침 버튼 -->
        <div class="py-3 d-flex align-items-center gap-3">
            <button type="button" class="refreshTime_css" th:onclick="|location.href='@{/monitoring/list}'|">
                새로고침
            </button>
        </div>

        <!-- 공정별 OK/NG율 파이차트 영역 -->
        <p class="fw-bold">공정별 OK/NG율</p>
        <div class="row p-3 justify-content-around">
            <!-- 공정 차트를 1~3번 공정에 대해 루프 렌더링 -->
            <div th:each="step : ${#numbers.sequence(1,3)}" class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-center" style="width: 100%; max-width: 500px;">
                    <p class="align-self-start" th:text="|${step}공정|"></p>
                    <canvas th:attr="id=${'myChart' + step}" style="width: 100%; height: auto;"></canvas>
                    <div th:attr="id=${'chartText' + step}" class="pt-2"></div>
                </div>
            </div>
        </div>

        <!-- 공정 로그 테이블 헤더 -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <p class="fw-bold mb-0">공정 로그</p>
            <a href="/monitoring/product/list" class="refreshTime_css" style="text-decoration: none;">제품리스트</a>
        </div>

        <!-- 공정 로그 테이블 -->
        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>제품명</th>
                    <th>로트넘버</th>
                    <th>공정No.</th>
                    <th>공정상태</th>
                    <th>공정생성일</th>
                    <th>에러코드</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="processForm : ${processes}">
                    <td th:text="${processForm.productName}"></td>
                    <td th:text="${processForm.lotNumber}"></td>
                    <td th:text="${processForm.processStep}"></td>
                    <td th:text="${processForm.processResultStatus}"></td>
                    <td th:text="${#temporals.format(processForm.createAt,'yyyy-MM-dd HH:mm')}"></td>
<!--                    <td th:text="${processForm.errorCode}"></td>-->
                    <td style="color: darkred;" th:id="'errorDesc-' + ${processFormStat.index}"
                        th:data-code="${processForm.errorCode}"
                        th:data-value="${processForm.errorValue}"
                        th:classappend="${processForm.errorCode == 'EXCEPTION_ERROR'} ? 'fw-bold' : ''">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</th:block>

<!-- 공정별 파이차트 스크립트 -->
<script th:inline="javascript" layout:fragment="script">
    Chart.register(ChartDataLabels);

    const okCounts = {
        1: /*[[${okCountByStep[1]?:0}]]*/ 0,
        2: /*[[${okCountByStep[2]?:0}]]*/ 0,
        3: /*[[${okCountByStep[3]?:0}]]*/ 0
    };

    const ngCounts = {
        1: /*[[${ngCountByStep[1]?:0}]]*/ 0,
        2: /*[[${ngCountByStep[2]?:0}]]*/ 0,
        3: /*[[${ngCountByStep[3]?:0}]]*/ 0
    };

    function drawChart(step) {
        const ok = okCounts[step];
        const ng = ngCounts[step];
        const total = ok + ng;
        const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
        const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

        const ctx = document.getElementById(`myChart${step}`);
        const chartText = document.getElementById(`chartText${step}`);

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['OK', 'NG'],
                datasets: [{
                    data: [ok, ng],
                    backgroundColor: ['#009913', '#ea2402'],
                    borderColor: '#fff',
                    borderWidth: 5,
                    offset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#fff',
                        formatter: (value, context) => {
                            const sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                            return sum > 0 ? `${((value / sum) * 100).toFixed(0)}%` : "0%";
                        },
                        font: (ctx) => {
                            const data = ctx.chart.data.datasets[0].data;
                            const val = ctx.dataset.data[ctx.dataIndex];
                            const total = data.reduce((a, b) => a + b, 0);
                            const ratio = val / total;
                            if (ratio < 0.1) return { size: 10, weight: 'bold' };
                            if (ratio < 0.2) return { size: 15, weight: 'bold' };
                            return { size: 20, weight: 'bold' };
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        if (chartText) {
            chartText.innerHTML =
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #009913; margin-right: 5px;"></span>` +
                `<strong>OK</strong> ${ok}건 / ${okPercent}%<br>` +
                `<span style="display: inline-block; width: 20px; height: 10px; background-color: #ea2402; margin-right: 5px;"></span>` +
                `<strong>NG</strong> ${ng}건 / ${ngPercent}%`;
        }
    }

    [1, 2, 3].forEach(drawChart);

    function getErrorDescription(errorCode, value) {
        if (!errorCode || errorCode === "OK") return "_";

        switch (errorCode) {
            case "ERROR_101":
                return `ERROR_101_용접 출력 과다 (${value.toFixed(1)}V)`;
            case "ERROR_102":
                return `ERROR_102_용접 출력 부족 (${value.toFixed(1)}V)`;
            case "ERROR_201":
                return `ERROR_201_온도 이상 (${value.toFixed(1)}℃)`;
            case "ERROR_202":
                return `ERROR_202_온도 이하 (${value.toFixed(1)}℃)`;
            case "ERROR_103":
                return "ERROR_103_스크래치 불량";
            case "ERROR_110":
                return "ERROR_110_조립 불량";
            case "ERROR_111":
                return "ERROR_111_기능 불량";
            case "EXCEPTION_ERROR":
                return "EXCEPTION_ERROR"
            default:
                return "-";

        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        const rows = document.querySelectorAll("[id^=errorDesc-]");
        rows.forEach(el => {
            const code = el.getAttribute("data-code");
            const valueStr = el.getAttribute("data-value");

            // value가 NaN이면 기본값 0 사용
            const value = parseFloat(valueStr);
            const safeValue = isNaN(value) ? 0 : value;

            // code가 null, undefined, 빈 문자열, "OK"인 경우 "-"
            if (!code || code.trim() === "" || code === "OK") {
                el.textContent = "_";
            } else {
                el.textContent = getErrorDescription(code, safeValue);
            }
        });
    });
</script>
</html>
