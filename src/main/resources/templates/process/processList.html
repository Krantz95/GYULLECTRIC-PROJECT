<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css">공정 모니터링</div>

        <!-- 새로고침 버튼 / 새로고침 시간 구현 전 -->
        <div class="py-3 d-flex align-items-center gap-3">
            <button type="button" class="refreshTime_css" onclick="location.reload();">
                새로고침
            </button>
            <span>최근 업데이트: (시간 구현 전) 웹소캣으로 5초 업데이트하면 필요없나?  </span>
        </div>

        <!-- 공정별 OK/NG율 (sm일때는 차트1개씩 보이게)-->
        <p class="fw-bold">공정별 OK/NG율</p>

        <div class="row row-cols-1 row-cols-md-3 text-center g-4">
            <div class="col">
                <p class="fs-5">1공정</p>
                <canvas id="myChart1" class="chart-canvas"></canvas>
                <ul class="pt-2">
                    <!--                <li><span th:text="${}"></span></li>-->
                    <li th:text="|정상 :${okCountByStep[1]?:0}|"></li>
                    <li th:text="|에러 :${ngCountByStep[1]?:0}|"></li>
                    <li th:text="|total :${totalCount}|"></li>
                </ul>
            </div>
            <div class="col">
                <p class="fs-5">2공정</p>
                <canvas id="myChart2" class="chart-canvas"></canvas>
                <ul>
                    <li th:text="|정상 :${okCountByStep[2]?:0}|"></li>
                    <li th:text="|에러 :${ngCountByStep[2]?:0}|"></li>
                    <li th:text="|total :${totalCount}|"></li>
                </ul>
            </div>
            <div class="col">
                <p class="fs-5">3공정</p>
                <canvas id="myChart3" class="chart-canvas"></canvas>
                <ul>
                    <li th:text="|정상 :${okCountByStep[3]?:0}|"></li>
                    <li th:text="|에러 :${ngCountByStep[3]?:0}|"></li>
                    <li th:text="|total :${totalCount}|"></li>
                </ul>
            </div>
        </div>

        <!-- 테이블 -->
        <div class="d-flex justify-content-between align-items-center">
            <p class="fw-bold mb-0">공정 로그</p>
            <a href="/monitoring/list" class="refreshTime_css" style="text-decoration: none;">제품리스트</a>
        </div>

        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>제품명</th>
                    <th>로트넘버</th>
                    <th>공정No.</th>
                    <th>공정상태</th>
                    <th>공정생성일</th>
                    <th>에러코드</th>
                </tr>
                </thead>
                <tbody>
                                    <tr th:each="processForm : ${processes}">
                                        <td th:text="${processForm.productName.name()}"></td>
                                        <td th:text="${processForm.lotNumber}"></td>
                                        <td th:text="${processForm.processStep}"></td>
                                        <td th:text="${processForm.processResultStatus}"></td>
                                        <td th:text="${#temporals.format(processForm.createAt,'yyyy-MM-dd HH-mm')}"></td>
                                        <td th:text="${processForm.errorCode}"></td>
                                    </tr>

                </tbody>
            </table>
        </div>
    </div>
    </div>
</th:block>

    <!-- 도넛차트 그리기 -->
    <script th:inline="javascript" layout:fragment="script">
        <!--데이터 가져오기-->
        var ng1 = /*[[${ngCountByStep[1]?:0}]]*/0;
        var ok1 = /*[[${okCountByStep[1]?:0}]]*/0;

        var ng2 = /*[[${ngCountByStep[2]?:0}]]*/0;
        var ok2 = /*[[${okCountByStep[2]?:0}]]*/0;

        var ng3 = /*[[${ngCountByStep[3]?:0}]]*/0;
        var ok3 = /*[[${okCountByStep[3]?:0}]]*/0;
        // function drawChart(ctx, ok, ng, textElementId) {
        //     const total = ok + ng;
        //     const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
        //     const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;
function drawChart(ctx,ok,ng) {
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['OK', 'NG'],
            datasets: [{
                label: '공정 상태',
                data: [ok, ng],
                backgroundColor: ['#4CAF50', '#F44336'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true, // 차트 반응형
            maintainAspectRatio: true, // 비율 유지하여 캔버스가 너무 커지지 않도록
            cutout: '40%', // 파이차트 내부 원 크기 줄이기
            plugins: {
                legend: {display: false} // 범례 숨기기
            }
        }
    });
}
            // ⬇퍼센트/수치 텍스트 자동 삽입
            // 이 부분은 선생님이 알려주신 웹소캣 중에
            const textDiv = document.getElementById(textElementId);
            textDiv.innerHTML =
                `<span style="font-weight:bold;">OK </span><span>${ok}건 / ${okPercent}%</span><br>` +
                `<span style="font-weight:bold;">NG </span><span>${ng}건 / ${ngPercent}%</span>`;
        }


        // 차트생성
        drawChart(document.getElementById('myChart1'),ok1,ng1);
        drawChart(document.getElementById('myChart2'),ok2,ng2);
        drawChart(document.getElementById('myChart3'),ok3,ng3);

    </script>

</html>