<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- ÏÑúÎ∏åÌÉÄÏù¥ÌãÄ -->
        <div class="subtitle_css">Í≥µÏ†ï Î™®ÎãàÌÑ∞ÎßÅ</div>

        <!-- ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº / ÏÉàÎ°úÍ≥†Ïπ® ÏãúÍ∞Ñ Íµ¨ÌòÑ Ï†Ñ -->
        <div class="py-3 d-flex align-items-center gap-3">
            <button type="button" class="refreshTime_css" th:onclick="|location.href='@{/monitoring/list}'|">
                ÏÉàÎ°úÍ≥†Ïπ®
            </button>
        </div>

        <!-- Í≥µÏ†ïÎ≥Ñ OK/NGÏú® (smÏùºÎïåÎäî Ï∞®Ìä∏1Í∞úÏî© Î≥¥Ïù¥Í≤å)-->
        <p class="fw-bold">Í≥µÏ†ïÎ≥Ñ OK/NGÏú®</p>

        <div class="row p-3 justify-content-around">
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-end" style="width: 100%; max-width: 500px;"> <!-- smÏóêÏÑú Ï∞®Ìä∏ ÌÅ¨Í∏∞ ÏÑ§Ï†ï -->
                    <p class="align-self-start">1Í≥µÏ†ï</p>
                    <p class="pt-2" id="text1"></p><br>
                    <canvas id="myChart1" style="width: 100%; height: auto;"></canvas><br>
                <ul class="pt-2">
                    <!--                <li><span th:text="${}"></span></li>-->
                    <li th:text="|Ï†ïÏÉÅ : ${okCountByStep[1]?:0}|"></li>
                    <li th:text="|ÏóêÎü¨ : ${ngCountByStep[1]?:0}|"></li>
                    <li th:text="|total : ${totalCount}|"></li>
                </ul>
            </div>
            </div>
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-end" style="width: 100%; max-width: 500px;"> <!-- smÏóêÏÑú Ï∞®Ìä∏ ÌÅ¨Í∏∞ ÏÑ§Ï†ï -->
                    <p class="align-self-start" >2Í≥µÏ†ï</p>
                    <p class="pt-2" id="text2"></p><br>
                    <canvas id="myChart2" style="width: 100%; height: auto;"></canvas><br>
                <ul>
                    <li th:text="|Ï†ïÏÉÅ : ${okCountByStep[2]?:0}|"></li>
                    <li th:text="|ÏóêÎü¨ : ${ngCountByStep[2]?:0}|"></li>
                    <li th:text="|total : ${totalCount}|"></li>
                </ul>
                </div>
            </div>
            <div class="col-lg-3 col-12 d-flex justify-content-center">
                <div class="d-flex flex-column align-items-end" style="width: 100%; max-width: 500px;"> <!-- smÏóêÏÑú Ï∞®Ìä∏ ÌÅ¨Í∏∞ ÏÑ§Ï†ï -->
                    <p class="align-self-start">3Í≥µÏ†ï</p>
                    <p id="text3" class="pt-2"></p><br>
                    <canvas id="myChart3" style="width: 100%; height: auto;"></canvas><br>
                <ul>
                    <li th:text="|Ï†ïÏÉÅ : ${okCountByStep[3]?:0}|"></li>
                    <li th:text="|ÏóêÎü¨ : ${ngCountByStep[3]?:0}|"></li>
                    <li th:text="|total : ${totalCount}|"></li>
                </ul>
                </div>
            </div>
            </div>

        <!-- ÌÖåÏù¥Î∏î -->
        <div class="d-flex justify-content-between align-items-center">
            <p class="fw-bold mb-0">Í≥µÏ†ï Î°úÍ∑∏</p>
            <a href="/monitoring/product/list" class="refreshTime_css" style="text-decoration: none;">Ï†úÌíàÎ¶¨Ïä§Ìä∏</a>
        </div>

        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>Ï†úÌíàÎ™Ö</th>
                    <th>Î°úÌä∏ÎÑòÎ≤Ñ</th>
                    <th>Í≥µÏ†ïNo.</th>
                    <th>Í≥µÏ†ïÏÉÅÌÉú</th>
                    <th>Í≥µÏ†ïÏÉùÏÑ±Ïùº</th>
                    <th>ÏóêÎü¨ÏΩîÎìú</th>
                </tr>
                </thead>
                <tbody>
                                    <tr th:each="processForm : ${processes}">
                                        <td th:text="${processForm.productName}"></td>
                                        <td th:text="${processForm.lotNumber}"></td>
                                        <td th:text="${processForm.processStep}"></td>
                                        <td th:text="${processForm.processResultStatus}"></td>
                                        <td th:text="${#temporals.format(processForm.createAt,'yyyy-MM-dd HH-mm')}"></td>
                                        <td th:text="${processForm.errorCode}"></td>
                                    </tr>

                </tbody>
            </table>
        </div>
    </div>
    </div>
</th:block>

    <!-- ÌååÏù¥Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞ -->
    <script th:inline="javascript" layout:fragment="script">
        <!--Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞-->
        var ng1 = /*[[${ngCountByStep[1]?:0}]]*/0;
        var ok1 = /*[[${okCountByStep[1]?:0}]]*/0;

        var ng2 = /*[[${ngCountByStep[2]?:0}]]*/0;
        var ok2 = /*[[${okCountByStep[2]?:0}]]*/0;

        var ng3 = /*[[${ngCountByStep[3]?:0}]]*/0;
        var ok3 = /*[[${okCountByStep[3]?:0}]]*/0;

        Chart.register(ChartDataLabels);


function drawChart(ctx,ok,ng, textElementId) {
    const total = ok + ng;
    const okPercent = total > 0 ? ((ok / total) * 100).toFixed(0) : 0;
    const ngPercent = total > 0 ? ((ng / total) * 100).toFixed(0) : 0;

    const chart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['OK', 'NG'],
            datasets: [{
                label: 'Í≥µÏ†ï ÏÉÅÌÉú',
                data: [ok, ng],
                backgroundColor: ['#009913', '#ea2402'],
                borderColor: '#fff',       // Ï°∞Í∞Å ÏÇ¨Ïù¥ Ìù∞ÏÉâ ÏÑ†
                borderWidth: 5,            // Ï°∞Í∞Å ÏÇ¨Ïù¥ Í∞ÑÍ≤© ÎëêÍªò
                offset: 10                 // Ï°∞Í∞ÅÏùÑ Î∞îÍπ•Ï™ΩÏúºÎ°ú ÏïΩÍ∞Ñ Î∂ÑÎ¶¨
            }]
        },

        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                datalabels: {
                    clip: false, // üî• Í∏ÄÏûêÍ∞Ä ÏûòÎ†§ÎÇòÍ∞ÄÎäî ÌòÑÏÉÅ Î∞©ÏßÄ
                    clamp: true, // üî• Ï∞®Ìä∏ Í≤ΩÍ≥ÑÏóê Í∏ÄÏûêÍ∞Ä Í±∏Î¶¨Î©¥ Î∞îÍπ•Ï™ΩÏúºÎ°ú Î∞ÄÍ∏∞
                    color: '#fff',
                    formatter: (value, context) => {
                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                        return `${percentage}%`;
                    },
                    font: function(context) {
                        const data = context.chart.data.datasets[0].data;
                        const value = context.dataset.data[context.dataIndex];
                        const total = data.reduce((a, b) => a + b, 0);
                        const percent = value / total;

                        // ÌçºÏÑºÌä∏Í∞Ä ÏûëÏúºÎ©¥ Í∏ÄÏûê ÏûëÍ≤å, ÌÅ¨Î©¥ ÌÅ¨Í≤å
                        if (percent < 0.1) {
                            return { size: 10, weight: 'bold' };
                        } else if (percent < 0.2) {
                            return { size: 15, weight: 'bold' };
                        } else {
                            return { size: 20, weight: 'bold' };
                        }
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    //     options: {
    //         responsive: true, // Ï∞®Ìä∏ Î∞òÏùëÌòï
    //         maintainAspectRatio: true, // ÎπÑÏú® Ïú†ÏßÄÌïòÏó¨ Ï∫îÎ≤ÑÏä§Í∞Ä ÎÑàÎ¨¥ Ïª§ÏßÄÏßÄ ÏïäÎèÑÎ°ù
    //         // cutout: '40%', // ÌååÏù¥Ï∞®Ìä∏ ÎÇ¥Î∂Ä Ïõê ÌÅ¨Í∏∞ Ï§ÑÏù¥Í∏∞
    //         plugins: {
    //             legend: {display: false} // Î≤îÎ°Ä Ïà®Í∏∞Í∏∞
    //         }
    //     }
    // });

    const textDiv = document.getElementById(textElementId);
    if (textDiv) {
        textDiv.innerHTML =
            `<span style="display: inline-block; width: 20px; height: 10px; background-color: #009913; margin-right: 5px;"></span>`
            + `<span style="font-weight:bold;  font-size: 15px">OK </span><span style="font-size: 15px">${ok}Í±¥ / ${okPercent}%</span><br>` +
            `<span style="display: inline-block; width: 20px; height: 10px; background-color: #ea2402; margin-right: 5px;"></span>` +
            `<span style="font-weight:bold; font-size: 15px">NG </span><span style="font-size: 15px">${ng}Í±¥ / ${ngPercent}%</span>`;

    }
    return chart; // üî• chart Í∞ùÏ≤¥ Î∞òÌôò
}

        // Ï∞®Ìä∏ÏÉùÏÑ±
        drawChart(document.getElementById('myChart1'),ok1,ng1,'text1');
        drawChart(document.getElementById('myChart2'),ok2,ng2,'text2');
        drawChart(document.getElementById('myChart3'),ok3,ng3,'text3');

    </script>

</html>