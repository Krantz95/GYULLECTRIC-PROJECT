<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css">제품리스트</div>

        <!-- 테이블 -->
        <div style="width: 800px;">
            <p class="pt-3">제품별 생산 달성률(%)</p>
            <canvas id="achievementChart" style="max-width: 100%; height: 200px;"></canvas>

        </div>

        <!-- 임시 구현 그래프  -->
        <p class="pt-5">제품 리스트</p>
        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>주문번호</th>
                    <th>제품명</th>
                    <th>주문수량</th>
                    <th>담당직원</th>
                    <th>주문날짜</th>
                    <th>에러</th>
                    <th>완제품</th>
                    <th>달성률</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="order : ${orderLists}">
                    <td th:text="${order.id}"></td>
                    <td th:text="${order.productName}"></td>
                    <td th:text="${order.quantity}"></td>
                    <td th:text="${order.members.name}"></td>
                    <td th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}"></td>
                    <td th:text="${errorCountMap[order.id]}"></td>
                    <td th:text="${completeCountMap[order.id]}"></td>
                    <td th:text="${#numbers.formatDecimal(achievementRateMap[order.id], 1, 'POINT', 1, 'POINT')} + '%'"></td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</th:block>


    <!-- 열어서 안에 주석 참고 // 임시 구현 가로 막대 차트 -->
    <script th:inline="javascript" layout:fragment="script">

        /*<![CDATA[*/
        let chartData = /*[[${chartData}]]*/ '{}';
        chartData = JSON.parse(chartData);

        const ctx = document.getElementById('achievementChart').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: '제품별 달성률 (%)',
                    data: chartData.data,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: '달성률 (%)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.x.toFixed(2) + '%';
                            }
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });

        /*]]>*/
    </script>


        // const chartData = /*[[${chartData}]]*/ 'null';
        // const parsedChartData = JSON.parse(chartData);
        //
        // const labels = parsedChartData.labels;
        // const orderQty = parsedChartData.orderQuantity;
        // const completeQty = parsedChartData.productCount;
        //
        // const achievementRates = completeQty.map((complete, idx) => {
        //     const ordered = orderQty[idx] || 1;
        //     return ((complete / ordered) * 100).toFixed(1);
        // });
        //
        // const ctx = document.getElementById('achievementChart').getContext('2d');
        //
        // const data = {
        //     labels: labels,
        //     datasets: [{
        //         label: '달성률 (%)',
        //         data: achievementRates,
        //         backgroundColor: labels.map((_, i) => {
        //             const colors = ['#FFCC00', '#02AD16', '#FF5900', '#007bff', '#ff33cc'];
        //             return colors[i % colors.length];
        //         }),
        //         borderWidth: 1
        //     }]
        // };
        //
        // const options = {
        //     indexAxis: 'y',
        //     scales: {
        //         x: {
        //             min: 0,
        //             max: 100,
        //             ticks: {
        //                 stepSize: 25,
        //                 callback: function (value) {
        //                     return value + '%';
        //                 }
        //             }
        //         }
        //     },
        //     plugins: {
        //         legend: { display: false },
        //         title: {
        //             display: true,
        //             text: '제품별 수율 (%)',
        //             font: { size: 16 }
        //         }
        //     }
        // };
        //
        // new Chart(ctx, {
        //     type: 'bar',
        //     data: data,
        //     options: options
        // });
      //  /*]]>*/


</html>
