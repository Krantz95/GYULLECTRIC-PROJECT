<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css"><i class="bi bi-lightning-charge"></i> 제품리스트</div>

        <!-- 테이블 -->
        <div style="width: 800px;">
            <p class="pt-3 fw-bold">제품별 생산 달성률(%)</p>
            <canvas id="achievementChart" style="max-width: 100%; height: 200px;"></canvas>

        </div>

        <!-- 임시 구현 그래프  -->
        <p class="pt-5 fw-bold">제품 리스트</p>
        <div class="table-responsive pt-2" style="overflow-x: auto;">
            <table class="table table-bordered text-center align-middle table2_css">
                <thead>
                <tr>
                    <th>주문번호</th>
                    <th>제품명</th>
                    <th>주문수량</th>
                    <th>담당직원</th>
                    <th>주문날짜</th>
                    <th>에러</th>
                    <th>완제품</th>
                    <th>달성률</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="orderList : ${orderLists}">
                    <td th:text="${orderList.id}">주문번호</td>
                    <td th:text="${orderList.productName}">제품명</td>
                    <td th:text="${orderList.quantity}">주문수량</td>
                    <td th:text="${orderList.members.name}">담당직원</td>
                    <td th:text="${#temporals.format(orderList.orderDate, 'yyyy-MM-dd HH:mm')}">주문날짜</td>
                    <td th:text="${orderNgCountMap[orderList.id]} ?: 0">불량 수</td>
                    <td th:text="${orderCompleteCountMap[orderList.id]} ?: 0">완제품 수</td>
                    <td th:text="${orderAchievementRateMap[orderList.id]} + '%' ?: 0">달성률</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

<!-- 열어서 안에 주석 참고 // 임시 구현 가로 막대 차트 -->
<script th:inline="javascript" layout:fragment="script">
    /*<![CDATA[*/
    const chartData = /*[[${chartData}]]*/ '{}';

    const parsedChartData = JSON.parse(chartData);
    const labels = parsedChartData.labels;
    const orderQty = parsedChartData.orderQuantity;
    const completeQty = parsedChartData.productCount;

    const achievementRates = completeQty.map((complete, idx) => {
        const ordered = orderQty[idx] || 1;
        return ((complete / ordered) * 100).toFixed(1);
    });


    function getBarColor(rate) {
        rate = parseFloat(rate);
        if (rate < 40) return '#F44336';     // 빨강 (위기)
        if (rate < 70) return '#F39C12';     // 주황 (경고)
        if (rate < 100) return '#FFCC00';    // 노랑 (양호)
        return '#4CAF50';                    // 초록 (완료)
    }

    const ctx = document.getElementById('achievementChart').getContext('2d');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '달성률 (%)',
                data: achievementRates,
                backgroundColor: achievementRates.map(getBarColor), // ✔ 조건부 색상 적용
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            scales: {
                x: {
                    min: 0,
                    max: 100,
                    ticks: {
                        stepSize: 25,
                        callback: function (value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: '제품별 수율 (%)',
                    font: { size: 16 }
                }
            }
        }
    });
    /*]]>*/
</script>
</th:block>
</html>
