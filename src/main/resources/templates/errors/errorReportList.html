<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css">에러 리포트</div>

        <!-- 검색 필터 -->
        <div class="my-3">
            <form th:action="@{/errors/report}" method="get" id="searchForm" class="d-flex justify-content-end align-items-center my-3 gap-2">
                <select name="type" class="pointer_orange form-select" style="width: 200px;">
                    <option value="" th:selected="${type == ''}">제목/작성자</option>
                    <option value="errorTitle" th:selected="${type == 'errorTitle'}">제목</option>
                    <option value="members" th:selected="${type == 'members'}">작성자</option>
                </select>
                <input type="text" class="form-control line2_css" style="width: 200px;" id="search_kw" th:value="${kw}" name="kw">
                <button class="btn_search px-4" id="btn_search" type="submit">검색</button>
                <input type="hidden" id="page" name="page" th:value="${paging != null ? paging.number : 0}">
            </form>
        </div>


        <!-- 테이블 -->
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle table1_css">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>제목</th>
                    <th>제품명</th>
                    <th>발생공정</th>
                    <th>작성일시</th>
                    <th>담당자</th>
                    <th>처리여부</th>
                </tr>
                </thead>
                <tbody>
                <!-- 임시 구현 - 해당 행 클릭시 페이지 넘어가게 -->
                <tr onclick="location.href='/errors/report_id'" style="cursor: pointer;" th:each="error, loop : ${paging.content}">
                    <td th:text="${error.id}">ID</td>
                    <td th:text="${error.getErrorTitle()}">제목</td>
                    <td th:text="${error.productName.name()}">제품명</td>
                    <td th:text="${error.getProcessStep()}">발생공정</td>
                    <td th:text="${#temporals.format(error.getWrittenAt(), 'yyyy-MM-dd HH:mm')}">작성일시</td>
                    <td th:text="${error.getMembers().name}">담당자</td>
                    <td>
                        <button class="status-btn status-unchecked" onclick="toggleStatus(this)">미처리</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 글쓰기 -->
    <div class="d-flex justify-content-end mt-1">
        <a th:href="@{/errors/recent-exceptions}" class="write_css">글쓰기</a>
    </div>

    <!-- 페이지네이션 (디자인)-->
    <div class="d-flex justify-content-center mt-4">
        <!-- 페이징 처리 시작 -->
        <div th:if="${!paging.isEmpty()}" class="py-3 d-flex justify-content-center">
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="page-item" th:classappend="${!paging.hasPrevious()} ? 'disabled'">
                        <a class="page-link" href="javascript:void(0)" th:data-page="${paging.number - 1}">&laquo;</a>
                    </li>
                    <li class="page-item"
                        th:each="page : ${#numbers.sequence(0, paging.totalPages - 1)}"
                        th:if="${page >= paging.number - 5 and page <= paging.number + 5}"
                        th:classappend="${page == paging.number} ? 'active'">
                        <a class="page-link" href="javascript:void(0)" th:text="${page + 1}" th:data-page="${page}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${!paging.hasNext()} ? 'disabled'">
                        <a class="page-link" href="javascript:void(0)" th:data-page="${paging.number + 1}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- 처리상태 비율 (%) -->
    <div class="pt-2">
        <p>처리상태 비율(%)</p>
        <div class="status-bar-container">
            <div class="status-segment status-unchecked" id="bar-unchecked">미처리(%)</div>
            <div class="status-segment status-checking" id="bar-checking">점검중(%)</div>
            <div class="status-segment status-resolved" id="bar-resolved">처리(%)</div>
        </div>
    </div>
</th:block>
    <!-- 처리여부 버튼 + 처리상태 비율 스크립트 -->
    <script th:inline="javascript" layout:fragment="script">

            $(function () {
            $(document).on('click', '.page-link', function () {
                let page = $(this).data('page');
                console.log("선택된 페이지 번호:", page);  // 반드시 숫자 확인
                if (page !== undefined) {
                    $('#page').val(page);
                    $('#searchForm').submit();
                }
            });

            // 검색 버튼 클릭
            $("#btn_search").on('click', function () {
            $('#page').val(0);
            $('#searchForm').submit();
        });

            // 엔터 입력 처리
            $("#search_kw").on("keypress", function(e) {
            if (e.which === 13) {
            e.preventDefault();
            $("#btn_search").click();
        }
        });
        });


    function toggleStatus(button) {
    if (button.classList.contains("status-unchecked")) {
    button.classList.remove("status-unchecked");
    button.classList.add("status-checking");
    button.textContent = "점검중";
    } else if (button.classList.contains("status-checking")) {
    button.classList.remove("status-checking");
    button.classList.add("status-resolved");
    button.textContent = "처리";
    } else {
    button.classList.remove("status-resolved");
    button.classList.add("status-unchecked");
    button.textContent = "미처리";
    }
    updateStatusBar();
        }

        function updateStatusBar() {
            const buttons = document.querySelectorAll('.status-btn');
            let unchecked = 0, checking = 0, resolved = 0;

            buttons.forEach(btn => {
                if (btn.classList.contains('status-unchecked')) unchecked++;
                else if (btn.classList.contains('status-checking')) checking++;
                else if (btn.classList.contains('status-resolved')) resolved++;
            });

            const total = unchecked + checking + resolved;
            const uncheckedPercent = total ? (unchecked / total * 100) : 0;
            const checkingPercent = total ? (checking / total * 100) : 0;
            const resolvedPercent = total ? (resolved / total * 100) : 0;

            const barUnchecked = document.getElementById('bar-unchecked');
            const barChecking = document.getElementById('bar-checking');
            const barResolved = document.getElementById('bar-resolved');

            // width 적용
            barUnchecked.style.width = uncheckedPercent + '%';
            barChecking.style.width = checkingPercent + '%';
            barResolved.style.width = resolvedPercent + '%';

            // 텍스트 설정
            barUnchecked.textContent = `미처리(${uncheckedPercent.toFixed(0)}%)`;
            barChecking.textContent = `점검중(${checkingPercent.toFixed(0)}%)`;
            barResolved.textContent = `처리(${resolvedPercent.toFixed(0)}%)`;

            // display 제어
            barUnchecked.style.display = uncheckedPercent > 0 ? 'flex' : 'none';
            barChecking.style.display = checkingPercent > 0 ? 'flex' : 'none';
            barResolved.style.display = resolvedPercent > 0 ? 'flex' : 'none';
        }

        window.addEventListener('load', function () {
            updateStatusBar();
        });


            document.getElementById('writeBtn').addEventListener('click', () => {
                fetch('/api/errors/recent-exceptions?limit=5')
                    .then(res => res.json())
                    .then(data => {
                        // 예를 들어 가장 최근 에러의 제목을 글쓰기 제목란에 넣기
                        if(data.length > 0) {
                            document.getElementById('errorTitleInput').value = data[0].title;
                            document.getElementById('errorDescriptionInput').value = data[0].description;
                            document.getElementById('errorProductNameInput').value = data[0].productName;
                            document.getElementById('errorProcessStepInput').value = data[0].processStep;
                            document.getElementById('errorContentInput').value = data[0].;
                            // 필요하면 더 넣기
                        }
                    });
            });
    </script>


</html>
