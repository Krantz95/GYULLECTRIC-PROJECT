<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css"><i class="bi bi-exclamation-triangle"></i> 에러 리포트</div>

        <!-- 검색 필터 -->
        <div class="my-3">
            <form th:action="@{/errors/report}" method="get" id="searchForm" class="d-flex justify-content-end align-items-center my-3 gap-2">
                <select name="type" class="pointer_orange form-select" style="width: 200px;">
                    <option value="" th:selected="${type == ''}">제목/작성자</option>
                    <option value="errorTitle" th:selected="${type == 'errorTitle'}">제목</option>
                    <option value="members" th:selected="${type == 'members'}">작성자</option>
                </select>
                <input type="text" class="form-control line2_css" style="width: 200px;" id="search_kw" th:value="${kw}" name="kw">
                <button class="btn_search px-4" id="btn_search" type="submit">검색</button>
                <input type="hidden" id="page" name="page" th:value="${paging != null ? paging.number : 0}">
            </form>
        </div>

        <!-- 에러 리포트 테이블 -->
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle table1_css">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>제목</th>
                    <th>제품명</th>
                    <th>발생공정</th>
                    <th>작성일시</th>
                    <th>담당자</th>
                    <th>처리여부</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="error : ${paging.content}" th:onclick="|location.href='/errors/report/' + ${error.id}|" style="cursor: pointer;">
                    <td th:text="${error.id}">ID</td>
                    <td th:text="${error.errorTitle}">제목</td>
                    <td th:text="${error.productName.name()}">제품명</td>
                    <td th:text="${error.processStep}">발생공정</td>
                    <td th:text="${#temporals.format(error.writtenAt, 'yyyy-MM-dd HH:mm')}">작성일시</td>
                    <td th:text="${error.members.name}">담당자</td>
                    <td>
                        <button class="status-btn status-unchecked" onclick="toggleStatus(this)">미처리</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 글쓰기 버튼 -->
        <div class="d-flex justify-content-end mt-1">
            <a th:href="@{/errors/recent-exceptions}" class="write_css">글쓰기</a>
        </div>

        <!-- 페이지네이션 -->
        <div class="d-flex justify-content-center mt-4">
            <div th:if="${!paging.isEmpty()}" class="py-3">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item" th:classappend="${!paging.hasPrevious()} ? 'disabled'">
                            <a class="page-link" href="javascript:void(0)" th:data-page="${paging.number - 1}">&laquo;</a>
                        </li>
                        <li class="page-item"
                            th:each="page : ${#numbers.sequence(0, paging.totalPages - 1)}"
                            th:if="${page >= paging.number - 5 and page <= paging.number + 5}"
                            th:classappend="${page == paging.number} ? 'active'">
                            <a class="page-link" href="javascript:void(0)" th:data-page="${page}" th:text="${page + 1}"></a>
                        </li>
                        <li class="page-item" th:classappend="${!paging.hasNext()} ? 'disabled'">
                            <a class="page-link" href="javascript:void(0)" th:data-page="${paging.number + 1}">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- 처리상태 비율 바 -->
        <div class="pt-2">
            <p>처리상태 비율(%)</p>
            <div class="status-bar-container">
                <div class="status-segment status-unchecked" id="bar-unchecked">미처리(%)</div>
                <div class="status-segment status-checking" id="bar-checking">점검중(%)</div>
                <div class="status-segment status-resolved" id="bar-resolved">처리(%)</div>
            </div>
        </div>
    </div>
</th:block>

<!-- 상태 토글 및 검색/페이지 처리 스크립트 -->
<script th:inline="javascript" layout:fragment="script">
    $(function () {
        // 페이지네이션 클릭
        $(document).on('click', '.page-link', function () {
            const page = $(this).data('page');
            if (page !== undefined) {
                $('#page').val(page);
                $('#searchForm').submit();
            }
        });

        // 검색 버튼 클릭
        $("#btn_search").on('click', function () {
            $('#page').val(0);
            $('#searchForm').submit();
        });

        // 검색어 엔터 입력
        $("#search_kw").on("keypress", function (e) {
            if (e.which === 13) {
                e.preventDefault();
                $("#btn_search").click();
            }
        });
    });

    // 처리 상태 버튼 토글
    function toggleStatus(button) {
        const states = ["status-unchecked", "status-checking", "status-resolved"];
        const labels = ["미처리", "점검중", "처리"];

        for (let i = 0; i < states.length; i++) {
            if (button.classList.contains(states[i])) {
                button.classList.remove(states[i]);
                const nextIndex = (i + 1) % states.length;
                button.classList.add(states[nextIndex]);
                button.textContent = labels[nextIndex];
                break;
            }
        }
        updateStatusBar();
    }

    // 상태 비율 바 업데이트
    function updateStatusBar() {
        const buttons = document.querySelectorAll('.status-btn');
        let counts = { unchecked: 0, checking: 0, resolved: 0 };

        buttons.forEach(btn => {
            if (btn.classList.contains('status-unchecked')) counts.unchecked++;
            else if (btn.classList.contains('status-checking')) counts.checking++;
            else if (btn.classList.contains('status-resolved')) counts.resolved++;
        });

        const total = counts.unchecked + counts.checking + counts.resolved;
        const percent = key => total ? (counts[key] / total * 100).toFixed(0) : 0;

        const setBar = (id, label, value) => {
            const el = document.getElementById(id);
            el.style.width = value + '%';
            el.textContent = `${label}(${value}%)`;
            el.style.display = value > 0 ? 'flex' : 'none';
        };

        setBar('bar-unchecked', '미처리', percent('unchecked'));
        setBar('bar-checking', '점검중', percent('checking'));
        setBar('bar-resolved', '처리', percent('resolved'));
    }

    window.addEventListener('load', updateStatusBar);
</script>
</html>
