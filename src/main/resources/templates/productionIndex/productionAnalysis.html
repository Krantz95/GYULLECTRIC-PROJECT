<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">

<!-- 서브타이틀 -->
        <div class="subtitle_css">생산지표관리_생산분석</div>

<!-- 인사이트 요약 -->
        <p class="py-3 fw-bold gap-3">인사이트 요약</p>
        <div class="row justify-content-center text-center">
            <div class="col-lg-4 col-12">
                <div class="form_insight">
                    <p class="fw-bold">총 생산량</p>
                    <p>450대</p>
                    <p>전월 대비 5% 증가</p>
                </div>
            </div>
            <div class="col-lg-4 col-12">
                <div class="form_insight">
                내용
                </div>
            </div>
            <div class="col-lg-4 col-12">
                <div class="form_insight">
                내용
                </div>
            </div>
        </div>

<!-- 공정별 분석 그래프 2개 -->
        <div class="row">
            <!-- 첫 번째 -->
            <div class="col-lg-6 col-12">
                <p class="fw-bold py-3 text-start">공정별 생산효율 및 병목 분석</p>
                <div class="d-flex justify-content-center">
                    <canvas id="analysisChart1" class="mt-3" style="width: 80%;"></canvas>
                </div>
            </div>

            <!-- 두 번째 -->
            <div class="col-lg-6 col-12">
                <p class="fw-bold py-3 text-start">공정 가동률 분석</p>
                <!-- 셀렉트 -->
                <div class="d-flex justify-content-end align-items-center mb-3" style="width: 100%;">
                    <label for="UnitSelect" class="pe-3 mb-0">기준 단위 선택:</label>
                    <select id="UnitSelect" class="pointer_orange" style="max-width: 80px">
                        <option value="day">일</option>
                        <option value="week">주</option>
                        <option value="month">월</option>
                    </select>
                </div>
                <!-- 차트 (부모 col 너비 꽉 채움) -->
                <div class="d-flex justify-content-center" style="width: 100%;">
                    <div style="width: 300px; height: 300px;">  <!-- 크기 제한 -->
                        <canvas id="analysisChart2" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>

<!-- 전력량에 따른 상관관계분석 -->
        <div class="col-12">
            <p class="fw-bold py-3 text-start">전력량에 따른 불량률 상관관계 분석</p>
            <div class="d-flex justify-content-center">
                <canvas id="analysisChart3" class="mt-3" style="width: 80%;"></canvas>
            </div>
            <!-- 주의 문구 표시되는 부분 (스크립트 참조) -->
        </div>

    </div>

<!-- 차트 3개 스크립트 -->
    <script th:inline="javascript" layout:fragment="script">

    // 첫번째 차트
        document.addEventListener('DOMContentLoaded', function () {
        new Chart(document.getElementById('analysisChart1'), {
            type: 'line',
            data: {
                labels: ['1공정', '2공정', '3공정'],
                datasets: [
                    {
                        label: '평균처리시간(분)',
                        data: [190, 10, 350],  // 예시 데이터
                        borderColor: '#FFA500',
                        borderWidth: 3,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'line',
                            padding: 20,
                            color: 'black',
                            font: {
                                size: 15
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 360,
                        ticks: {
                            stepSize: 90
                        }
                    }
                }
            }
        });
    // 두 번째 차트: 공정 가동률 분석 (도넛 차트)
            new Chart(document.getElementById('analysisChart2'), {
                type: 'doughnut',
                data: {
                    labels: ['1공정', '2공정', '3공정'],
                    datasets: [{
                        data: [75, 60, 50],  // 예시 가동률 (%)
                        backgroundColor: ['#FFA500', '#36A2EB', '#808080'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 15 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });


    // 세번째 차트 (전력량에 따른 불량률 상관관계 분석)
            const defectData = [20, 75, 25];  // 불량률 데이터 (datasets[1].data)
            const defectThreshold = 50;       // 임계치 (예: 50%)

            // 임계치 초과 공정 찾기
            const overThreshold = defectData
                .map((value, index) => ({ name: `${index + 1}공정`, value }))
                .filter(item => item.value >= defectThreshold);

            if (overThreshold.length > 0) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'text-center';
                warningDiv.innerHTML = `
                <div class="warning-box blinking">
                    ⚠ 주의! ${overThreshold.map(item => `${item.name} (${item.value}%)`).join(', ')} 불량률이 임계치 초과입니다.
                </div>
            `;
                const chartContainer = document.querySelector('#analysisChart3').parentElement;
                chartContainer.insertAdjacentElement('afterend', warningDiv);
            }


            new Chart(document.getElementById('analysisChart3'), {
                type: 'bar',
                data: {
                    labels: ['1공정', '2공정', '3공정'],
                    datasets: [
                        {
                            label: '전력량(kWh)',
                            data: [9, 18, 8],
                            backgroundColor: '#FFA500',
                            yAxisID: 'y',
                        },
                        {
                            label: '불량률(%)',
                            data: defectData,
                            backgroundColor: '#808080',
                            yAxisID: 'y1',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 15 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            min: 0,
                            max: 20,
                            ticks: {
                                stepSize: 5
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 25
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        });

    </script>
</th:block>
</html>
