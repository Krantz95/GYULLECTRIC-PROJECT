<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">
    <div class="py-4">
        <div class="subtitle_css"><i class="bi bi-graph-up-arrow"></i> 생산지표관리_생산분석</div>

        <!-- 인사이트 요약 (KPI) -->
        <p class="fw-bold mt-3 mb-1">인사이트 요약</p>
        <div class="row justify-content-center text-center">
            <div class="row g-3 mt-1 text-center d-flex justify-content-center">
                <div class="col-lg-4 col-12">
                    <div class="kpi-card">
                        <p class="kpi-title"><i class="bi bi-bar-chart-fill"></i> 금일 목표 달성 현황</p>
                        <div class="kpi-value" id="kpi-completed" th:text="'300대 중 ' + ${kpi.completed} + '대 완료'"></div>
                        <div class="kpi-sub text-muted">달성률: <strong class="text-primary" id="kpi-achievementRate" th:text="${kpi.achievementRate + '%'}"></strong></div>
                    </div>
                </div>
                <div class="col-lg-4 col-12">
                    <div class="kpi-card">
                        <p class="kpi-title"><i class="bi bi-clock-fill"></i> 현재 속도</p>
                        <div class="kpi-value" id="kpi-currentSpeed" th:text="${currentSpeed} + '대/분'"></div>
                        <div class="kpi-sub text-muted" id="kpi-onTimeMessage" th:text="${onTime ? '납기 내 달성 예상' : '지연 예상'}"></div>
                    </div>
                </div>
                <div class="col-lg-4 col-12">
                    <div class="kpi-card">
                        <p class="kpi-title"><i class="bi bi-calendar-check-fill"></i> 납기 예측</p>
                        <div class="kpi-value text-success" id="kpi-expectedRate" th:text="${expectedRate + '%'}"></div>
                        <div class="kpi-sub text-muted">
                            <span id="kpi-onTimeMessage2" th:text="${onTime ? '납기 내 완료 가능' : '지연 예상'}"></span><br>
                            남은 예상시간: <strong id="kpi-estimatedTime" th:text="${estimatedTime}"></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 병목 분석 KPI 출력 -->
        <div class="row justify-content-center text-center">
            <div class="col-lg-6 col-12">
                <div class="kpi-card mt-4">
                    <p class="kpi-title text-danger"><i class="bi bi-exclamation-triangle-fill"></i> 병목 원인 분석</p>
                    <div class="kpi-value" th:text="${bottleneck != null ? bottleneck.processName : '분석 불가'}"></div>
                    <div class="kpi-sub text-muted" th:text="${bottleneck != null ? bottleneck.mainCause : '원인 정보를 불러올 수 없습니다'}"></div>
                </div>
            </div>
        </div>

        <!-- 공정별 분석 그래프 -->
        <div class="row">
            <div class="col-lg-6 col-12">
                <p class="fw-bold py-3 text-start">공정별 생산효율 분석</p>
                <div class="d-flex justify-content-center">
                    <canvas id="analysisChart1" class="mt-3 chart-lg"></canvas>
                </div>
            </div>
            <div class="col-lg-6 col-12">
                <p class="fw-bold py-3 text-start">병목 분석 (에러 발생 건수 기준)</p>
                <div class="d-flex justify-content-center">
                    <div class="chart-sm">
                        <canvas id="analysisChart2"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 전력량에 따른 불량률 상관관계 분석 -->
        <div class="col-12">
            <p class="fw-bold py-3 text-start">전력량에 따른 불량률 상관관계 분석</p>
            <div class="d-flex justify-content-center">
                <canvas id="analysisChart3" class="mt-3 chart-lg"></canvas>
            </div>
        </div>
    </div>

    <!-- WebSocket & Chart.js 연동 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script th:inline="javascript" layout:fragment="script">
        document.addEventListener('DOMContentLoaded', function () {
            const chart1 = new Chart(document.getElementById('analysisChart1'), {
                type: 'line',
                data: { labels: ['프레임공정', '도장공정', '조립공정'], datasets: [{ label: '평균처리시간(분)', data: [0, 0, 0], borderColor: '#FFA500', borderWidth: 3, fill: false }] },
                options: { responsive: true, plugins: { legend: { position: 'top', labels: { pointStyle: 'line', usePointStyle: true, font: { size: 15 } } } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 10 } } } }
            });

            const chart2 = new Chart(document.getElementById('analysisChart2'), {
                type: 'doughnut',
                data: { labels: ['프레임공정', '도장공정', '조립공정'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#FFA500', '#FF4C4C', '#36A2EB'], borderWidth: 1 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 15 } } }, tooltip: { callbacks: { label: ctx => `${ctx.label}: 에러 ${ctx.raw}건` } } } }
            });

            const chart3 = new Chart(document.getElementById('analysisChart3'), {
                type: 'bar',
                data: {
                    labels: ['프레임공정', '도장공정', '조립공정'],
                    datasets: [
                        { label: '전력량(kWh)', data: [0, 0, 0], backgroundColor: '#FFA500', yAxisID: 'y' },
                        { label: '불량률(%)', data: [0, 0, 0], backgroundColor: '#808080', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top', labels: { font: { size: 15 } } } },
                    scales: {
                        y: { position: 'left', beginAtZero: true, suggestedMax: 15, ticks: { stepSize: 5 }, title: { display: true, text: '전력량(kWh)' } },
                        y1: { position: 'right', beginAtZero: true, suggestedMax: 100, ticks: { stepSize: 25 }, grid: { drawOnChartArea: false }, title: { display: true, text: '불량률(%)' } }
                    }
                }
            });

            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                stompClient.subscribe('/topic/analysis', function (message) {
                    const data = JSON.parse(message.body);

                    // KPI 실시간 업데이트
                    if (data.kpi) {
                        document.getElementById('kpi-completed').innerText = `300대 중 ${data.kpi.completed}대 완료`;
                        document.getElementById('kpi-achievementRate').innerText = `${data.kpi.achievementRate}%`;
                        document.getElementById('kpi-currentSpeed').innerText = `${data.kpi.currentSpeed}대/분`;
                        document.getElementById('kpi-expectedRate').innerText = `${data.kpi.expectedRate}%`;
                        document.getElementById('kpi-estimatedTime').innerText = data.kpi.estimatedTime;
                        document.getElementById('kpi-onTimeMessage').innerText = data.kpi.expectedRate >= 100 ? '납기 내 달성 예상' : '지연 예상';
                        document.getElementById('kpi-onTimeMessage2').innerText = data.kpi.expectedRate >= 100 ? '납기 내 완료 가능' : '지연 예상';
                    }

                    // Chart 업데이트
                    const t = data.avgProcessingTime || {};
                    chart1.data.datasets[0].data = [t[1] || 0, t[2] || 0, t[3] || 0].map(v => (v / 60).toFixed(1));
                    chart1.update();

                    const e = data.errorCounts || {};
                    chart2.data.datasets[0].data = [e[1] || 0, e[2] || 0, e[3] || 0];
                    chart2.update();

                    const pd = data.powerDefect || {};
                    chart3.data.datasets[0].data = [pd[1]?.power || 0, pd[2]?.power || 0, pd[3]?.power || 0];
                    chart3.data.datasets[1].data = [pd[1]?.defect || 0, pd[2]?.defect || 0, pd[3]?.defect || 0];
                    chart3.update();
                });
            });
        });
    </script>
</th:block>
</html>
