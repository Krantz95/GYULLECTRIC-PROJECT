<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">

    <div class="py-4">
        <!-- 서브타이틀 -->
        <div class="subtitle_css"><i class="bi bi-activity"></i> 생산지표관리_불량예측</div>
        <div class="fw-bold py-3">기계 이상 감지</div>

        <!-- 주조 공정 -->
        <div class="row justify-content-center">
            <div class="col-lg-6 col-12 text-center">
                <!-- 경고 메시지 위치 (높이 고정) -->
                <div id="castingWarning" class="warning-placeholder"></div> <!--warning-placeholder : 경고문구가 없어도 해당 행칸 유지 -->

                <div style="display: block; width: 70%; margin: 0 auto; padding: 0;">
                    <canvas id="castingChart" style="display: block; width: 100%; max-height: 300px; margin-bottom: 0;"></canvas>
                    <div id="castingStatus" class="d-flex justify-content-between align-items-center" style="margin-top: 0; padding-top: 0;">
                        <div class="defect-box"> <!-- 차트아래 위치 정렬 -->
                            <span class="defect-label">압력/온도 감지 (80%)</span>
                            <button type="button" class="defect-btn" style="background-color: #FF0004;" disabled>점검요청</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 용접 공정 -->
            <div class="col-lg-6 col-12 text-center">
                <!-- 경고 메시지 (높이 고정) -->
                <div id="weldingWarning" class="warning-placeholder"></div>

                <div style="display: block; width: 70%; margin: 0 auto; padding: 0;">
                    <canvas id="weldingChart" style="display: block; width: 100%;  max-height: 300px; margin-bottom: 0;"></canvas>
                    <div id="weldingStatus" class="d-flex justify-content-between align-items-center" style="margin-top: 0; padding-top: 0;">
                        <div class="defect-box"> <!-- 차트아래 위치 정렬 -->
                            <span class="defect-label">용접 출력 감지 (0%)</span>
                            <button type="button" class="defect-btn" style="background-color: #FF0004;" disabled>점검요청</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 경고 로그 테이블-->
        <div class="py-3 fw-bold">경고 로그</div>
        <table class="table-responsive">
            <table class="table table-bordered text-center align-middle table1_css">
                <thead>
                <tr>
                    <th class="col-small">발생일시</th>
                    <th class="col-small">발생공정</th>
                    <th class="col-large">감지 현상</th>
                    <th>확인</th>
                </tr>
                </thead>
                </thead>
                <tbody>
                <tr>
                    <td>2025.05.13 10:02</td>
                    <td>1공정</td>
                    <td>압력 온도 초과 </td>
                    <td><button class="status-btn status-unchecked" style="background-color: #FF5900; color: black">점검요청</button></td>
                </tr>
                <tr>
                    <td>2025.05.14 18:25</td>
                    <td>2공정</td>
                    <td>배터리팩 용접 출력 이상 - 점검 필요</td>
                    <td><button class="status-btn status-unchecked" style="background-color: #FF5900; color: black">점검요청</button></td>
                </tr>
                </tbody>
            </table>
        </table>
    </div>

    <!-- 차트 2개 스크립트 -->
    <script th:inline="javascript" layout:fragment="script">
        document.addEventListener('DOMContentLoaded', function () {
            const datasets = [
                { id: 'castingChart', statusId: 'castingStatus', warningId: 'castingWarning', label: '압력/온도 감지', value: 80 }, // 주조 %값 임시지정
                { id: 'weldingChart', statusId: 'weldingStatus', warningId: 'weldingWarning', label: '용접 출력 감지', value: 20 }   // 용접 %값 임시지정
            ];

            datasets.forEach(data => {
                const canvas = document.getElementById(data.id);
                const ctx = canvas.getContext('2d');

                canvas.width = canvas.parentNode.offsetWidth;

                let bgColor;
                if (data.value <= 60) {
                    bgColor = 'green';
                } else if (data.value <= 79) {
                    bgColor = '#FFD700';
                } else {
                    bgColor = 'red';
                }

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [data.value, 100 - data.value],
                            backgroundColor: [bgColor, '#878787'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,  // 강제 비율 끄기
                        responsive: true,            // 부모 div 크기에 맞게
                        circumference: 180,
                        rotation: 270,
                        cutout: '50%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false } // 툴팁 완전 비활성화 (겹치는 문제)
                        }
                    },
                    plugins: [{ // 차크 중간 % 직접 그리기
                        afterDraw: chart => {
                            const { ctx, chartArea: { width, height } } = chart;  // 캔버스 컨텍스트와 차트 영역 크기 가져오기
                            const centerX = width / 2;                            // 차트 중심 X 좌표 계산
                            const centerY = height / 1.3;                     // 차트 중심 Y 좌표 계산 (약간 아래로 조정)
                            const smallRadius = 50;                               // 안쪽 동그라미 반지름 설정

                            ctx.save();                                           // 현재 캔버스 상태 저장
                            ctx.beginPath();                                      // 새로운 경로 시작
                            ctx.arc(centerX, centerY, smallRadius, 0, 2 * Math.PI); // 중심에 작은 원 그리기
                            ctx.fillStyle = '#ffffff';                            // 안쪽 원 색상 흰색
                            ctx.fill();                                           // 원 내부 채우기
                            ctx.strokeStyle = '#F37221';                          // 원 테두리 색상 설정 (주황색)
                            ctx.lineWidth = 1;                                    // 테두리 두께 설정
                            ctx.stroke();                                         // 원 테두리 그리기
                            ctx.closePath();                                      // 경로 닫기

                            ctx.font = '15px sans-serif';                        // 텍스트 폰트 설정
                            ctx.fillStyle = 'black';                             // 텍스트 색상 설정
                            ctx.textAlign = 'center';                            // 텍스트 수평 정렬 중앙
                            ctx.textBaseline = 'middle';                         // 텍스트 수직 정렬 중앙
                            ctx.fillText(`${data.value}%`, centerX, centerY);    // 중심에 퍼센트 값 텍스트 그리기

                            ctx.restore();                                       // 저장해둔 캔버스 상태 복원
                        }
                    }]
                });

                const statusDiv = document.getElementById(data.statusId);
                const statusLabel = statusDiv.querySelector('.defect-label');
                const statusButton = statusDiv.querySelector('.defect-btn');

                if (data.value >= 80) {
                    statusButton.disabled = false;   // 기준 넘으면 활성화
                } else {
                    statusButton.disabled = true;    // 기준 미만이면 비활성화
                }

                // 상태 텍스트
                statusLabel.textContent = `${data.label} (${data.value}%)`;

                // 버튼 활성/비활성
                if (data.value >= 80) {
                    statusButton.disabled = false;
                } else {
                    statusButton.disabled = true;
                }

                // 경고 메시지 처리
                const warningDiv = document.getElementById(data.warningId);
                if (data.value >= 80) {
                    warningDiv.className = 'warning-box blinking warning-placeholder';
                    warningDiv.innerHTML = `⚠ 주의! ${data.label} 초과 경고`;
                } else {
                    warningDiv.className = 'warning-placeholder';
                    warningDiv.innerHTML = '';
                }
            });
        });

    </script>
</th:block>
</html>
