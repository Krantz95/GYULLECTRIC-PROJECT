<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">
    <div class="py-4">
        <!-- ì„œë¸Œíƒ€ì´í‹€ -->
        <div class="subtitle_css"><i class="bi bi-activity"></i> ìƒì‚°ì§€í‘œê´€ë¦¬_ë¶ˆëŸ‰ì˜ˆì¸¡</div>
        <div class="fw-bold py-3">ê¸°ê³„ ì´ìƒ ê°ì§€
            <form th:action="@{/indicators/defect-predict/reset}" method="post" class="pt-3">
                <button type="submit" style="background-color: #F37221; color: white; border: 1px solid #FF5900;">
                    ğŸ”„ ì„œë²„ ì´ˆê¸°í™”<!-- í…ŒìŠ¤íŠ¸ìš© -->
                </button>
            </form>
        </div>

        <!-- ì°¨íŠ¸1 / ë„ì¥(2ê³µì •) -->
        <div class="row justify-content-center">
            <div class="col-lg-6 col-12 text-center">
                <!-- ê²½ê³  ë©”ì‹œì§€ ìœ„ì¹˜ (ë†’ì´ ê³ ì •) -->
                <div id="castingWarning" class="warning-placeholder">
                    <div th:if="${castingWarningMsg != ''}" class="alert alert-warning" style="font-weight: bold;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span th:text="${castingWarningMsg}"></span>
                    </div>
                </div>
                <div style="display: block; width: 70%; margin: 0 auto; padding: 0;">
                    <!-- ğŸ”„ ë¡œë”© ë©”ì‹œì§€ (ì²˜ìŒì—ë§Œ í‘œì‹œ, JSì—ì„œ ìˆ¨ê¹€ ì²˜ë¦¬ë¨) -->
                    <div id="castingChartLoading" class="chart-loading-text"
                         style="text-align: center; padding: 2rem; font-weight: bold; color: #F37221;">
                        ì‹¤ì‹œê°„ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤
                    </div>
                    <canvas id="castingChart"
                            role="img"
                            aria-label="ì£¼ì¡° ê³µì • ì•ˆì •ì„± ì°¨íŠ¸"
                            style="display: none; width: 100%; max-height: 300px; margin-bottom: 0;"></canvas>
                    <div id="castingStatus" class="d-flex justify-content-between align-items-center"
                         style="margin-top: 0; padding-top: 0;">
                        <div class="defect-box">
                            <span class="defect-label defect-tooltip"
                                  data-bs-toggle="tooltip"
                                  data-bs-placement="top"
                                  data-bs-html="true"
                                  title="<b>2ê³µì • (ë„ì¥) ìµœì í™” ê¸°ì¤€</b><br>
                                        - ì••ì°© ì••ë ¥ 299 ì´ìƒ
                                        - ìƒë‹¨ ê¸ˆí˜• ì˜¨ë„ 94â„ƒ ì´ìƒ
                                        - í•˜í–¥ ê¸ˆí˜• ì˜¨ë„ 193â„ƒ ì´ìƒ">
                                          ì••ë ¥/ì˜¨ë„ ê°ì§€
                                        </span>
                            <button type="button"
                                    class="defect-btn"
                                    style="background-color: #FF5900; color: white;"
                                    onclick="requestInspection('ì••ì°© ì••ë ¥')">
                                ì ê²€ìš”ì²­
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì°¨íŠ¸2 : 1ê³µì •(ìš©ì ‘) -->
            <div class="col-lg-6 col-12 text-center">
                <!-- ê²½ê³  ë©”ì‹œì§€ ìœ„ì¹˜ (ë†’ì´ ê³ ì •) -->
                <div id="weldingWarning" class="warning-placeholder">
                    <div th:if="${weldingWarningMsg != ''}"
                         th:class="'alert ' +
                          (${weldingWarningMsg.contains('ì ê²€')} ? 'custom-danger' :
                           ${weldingWarningMsg.contains('ì£¼ì˜')} ? 'custom-warning' : '')"
                         style="font-weight: bold;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span th:text="${weldingWarningMsg}"></span>
                    </div>
                </div>
                <div style="display: block; width: 70%; margin: 0 auto; padding: 0;">
                    <!-- ğŸ”„ ë¡œë”© ë©”ì‹œì§€ (ì²˜ìŒì—ë§Œ í‘œì‹œ, JSì—ì„œ ìˆ¨ê¹€ ì²˜ë¦¬ë¨) -->
                    <div id="weldingChartLoading" class="chart-loading-text"
                         style="text-align: center; padding: 2rem; font-weight: bold; color: #F37221;">
                        ì‹¤ì‹œê°„ ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤
                    </div>
                    <canvas id="weldingChart"
                            role="img"
                            aria-label="ìš©ì ‘ ê³µì • ì•ˆì •ì„± ì°¨íŠ¸"
                            style="display: none; width: 100%; max-height: 300px; margin-bottom: 0;"></canvas>
                    <div id="weldingStatus" class="d-flex justify-content-between align-items-center"
                         style="margin-top: 0; padding-top: 0;">
                        <div class="defect-box">
                            <span class="defect-label">ìš©ì ‘ ì¶œë ¥ ê°ì§€ (0%)</span>
                            <button type="button"
                                    class="defect-btn"
                                    style="background-color: #FF5900; color: white;"
                                    onclick="requestInspection('ìš©ì ‘ ì¶œë ¥')">
                                ì ê²€ìš”ì²­
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²½ê³  ë¡œê·¸ í…Œì´ë¸”-->
        <div class="py-3 fw-bold">ê²½ê³  ë¡œê·¸</div>
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle table1_css">
                <thead>
                <tr> <!-- WarningDtoì™€ ì—°ê²° -->
                    <th class="col-small">ë°œìƒì¼ì‹œ</th>      <!-- timestamp -->
                    <th class="col-small">ê³µì •ë‹¨ê³„</th>      <!-- processStep -->
                    <th>ì¦ìƒ í•­ëª©</th>                      <!-- symptomItem -->
                    <th>ê°ì§€í˜„ìƒ</th>                        <!-- warningText -->
                    <th class="col-small">ì¶œë ¥ê°’</th>          <!-- score -->
                    <th class="col-small">ì‹¬ê°ë„</th>        <!-- warningLevel -->
                    <th>í™•ì¸</th>
                </tr>
                </thead>
                <tbody id="defectLogBody">
                <!-- ì‹¤ì‹œê°„ ë¡œê·¸ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ (JSì—ì„œ append) -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ / confirmDelete í•¨ìˆ˜ì™€ ì—°ë™ -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">ì ê²€ ìš”ì²­ í™•ì¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmModalSymptom" class="fw-bold text-center mb-2">ìš©ì ‘ ì¶œë ¥</p>
                    <p class="text-center">í•´ë‹¹ ê°ì§€ í˜„ìƒì— ëŒ€í•´ ì ê²€ ìš”ì²­ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" style="background-color: red; color: white"
                            onclick="confirmDelete()">ìš”ì²­
                    </button>
                </div>
            </div>
        </div>
    </div>


    <style> /* ì´ í˜ì´ì§€ì—ì„œë§Œ .table1_cssì˜ í–‰(td) ë°°ê²½ì„ í°ìƒ‰ìœ¼ë¡œ ê°•ì œ ì„¤ì • */
    .table1_css tbody tr td {
        background-color: white !important;
    }
    </style>


    <!-- ì°¨íŠ¸ 2ê°œ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript" layout:fragment="script">

        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let selectedSymptomForDelete = null;

        const inspectedSymptoms = new Set();
        let datasets = [];

        // ëª¨ë‹¬ ì—´ê¸° ë° ìƒˆë¡œìš´ ëª¨ë‹¬ ì—´ê¸° ê°€ëŠ¥ (ì´ˆê¸°í™”)
        window.requestInspection = function(symptom) {
            const modalBody = document.querySelector("#confirmModal .modal-body");
            const modalFooter = document.querySelector("#confirmModal .modal-footer");

            //  ëª¨ë‹¬ ë‚´ìš© ì´ˆê¸°í™” (ìš”ì²­ ì „ ìƒíƒœë¡œ)
            modalBody.innerHTML = `
                <p id="confirmModalSymptom" class="fw-bold text-center mb-2">${symptom}</p>
                <p class="text-center">í•´ë‹¹ ê°ì§€ í˜„ìƒì— ëŒ€í•´ ì ê²€ ìš”ì²­ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            `;
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger" style="background-color: red; color: white;"
                        onclick="confirmDelete()">ìš”ì²­</button>
            `;

            selectedSymptomForDelete = symptom;

            // ëª¨ë‹¬ ì—´ê¸°
            const modalEl = document.getElementById("confirmModal");
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) modal = new bootstrap.Modal(modalEl);
            modal.show();
             };

        window.confirmOnlyUiUpdate = function () {
            if (!selectedSymptomForDelete) return;

            const rows = document.querySelectorAll("#defectLogBody tr");
            rows.forEach(row => {
                const symptomText = row.children[2]?.textContent?.trim();
                if (symptomText === selectedSymptomForDelete) {
                    const button = row.querySelector("button.status-btn");
                    if (button) {
                        button.disabled = true;
                        button.innerText = "ì ê²€ì™„ë£Œ";
                        button.style.backgroundColor = "#ccc";
                        button.classList.remove("status-btn");
                        button.classList.add("disabled");
                    }
                }
            });
            const modalEl = document.getElementById("confirmModal");
            const modalInstance = bootstrap.Modal.getInstance(modalEl);
            if (modalInstance) {
                modalInstance.hide();
            }

            selectedSymptomForDelete = null;
        };

        // ğŸ›‘ ê²½ê³  ë©”ì‹œì§€ ë¶€ë¶„ (íƒ€ì„ë¦¬í”„ì—ì„œ ë°›ì€ ê²½ê³  ë©”ì‹œì§€ ë°”ì¸ë”©)
        const warningMessages = {
            casting: '[[${castingWarningMsg}]]',
            welding: '[[${weldingWarningMsg}]]'
        };


        document.addEventListener('DOMContentLoaded', function () {
            // ğŸ•’ WebSocket ìˆ˜ì‹  ì¶”ê°€
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);

            let castingChartInstance = null; // 1ë²ˆì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
            let weldingChartInstance = null; // 2ë²ˆì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤

            // ì—°ê²° í›„ /topic/defect êµ¬ë… ì‹œì‘
            stompClient.connect({}, () => {
                stompClient.subscribe('/topic/defect', function (message) {
                    const data = JSON.parse(message.body); // JSON ë¬¸ìì—´ì„ JS ê°ì²´ë¡œ ë³€í™˜
                    // ê° ì ìˆ˜ ì¶”ì¶œ (ë„ì¥ castingScore, ìš©ì ‘ weldingScore)
                    const castingScore = Number.isFinite(data.castingScore) ? data.castingScore : 0;
                    const weldingScore = Number.isFinite(data.weldingScore) ? data.weldingScore : 0;

                    // ë””ë²„ê¹…ìš© ë©”ì‹œì§€
                    console.log("ğŸ“¢ ì‹¤ì‹œê°„ ì˜ˆì¸¡ ë„ì°©:", data);
                    console.log("Casting Score:", data.castingScore);  // 0~100 ì¸ì§€ í™•ì¸
                    console.log("Casting Data ë°°ì—´:", [data.castingScore, 100 - data.castingScore]);
                    console.log("Flask ì‘ë‹µ defectLogs: ", data.defectLogs);

                    // ğŸ›‘ ê²½ê³  ë©”ì‹œì§€ ë¶€ë¶„ / ìµœì‹  ë©”ì‹œì§€ë¡œ warningMessages ì—…ë°ì´íŠ¸!
                    warningMessages.casting = data.castingWarning || "";
                    warningMessages.welding = data.weldingWarning || "";

                    // ë°ì´í„°ê°€ ìœ íš¨í•œì§€ ì²´í¬ í›„ ì—…ë°ì´íŠ¸
                    if (typeof data.castingScore !== 'number' || isNaN(data.castingScore)) {
                        data.castingScore = 0;
                    }
                    if (!data.weldingScore || isNaN(data.weldingScore)) {
                        data.weldingScore = 0;  // ê¸°ë³¸ê°’ ì„¤ì •
                    }

                    // ì „ì—­ ë³€ìˆ˜ datasets ì—…ë°ì´íŠ¸ (ì°¨íŠ¸/ê²½ê³ ë°•ìŠ¤/ìƒíƒœë°•ìŠ¤ìš© ì •ë³´)
                    setTimeout(() => {
                        datasets = [  // ì „ì—­ë³€ìˆ˜ì— ê°’ì„ "ì¬í• ë‹¹"ë§Œ í•¨!
                            {
                                id: 'castingChart',
                                statusId: 'castingStatus',
                                warningId: 'castingWarning',
                                msgKey: 'casting',
                                label: 'ì••ë ¥/ì˜¨ë„ ê°ì§€',
                                value: castingScore
                            },
                            {
                                id: 'weldingChart',
                                statusId: 'weldingStatus',
                                warningId: 'weldingWarning',
                                msgKey: 'welding',
                                label: 'ìš©ì ‘ ì¶œë ¥ ê°ì§€',
                                value: weldingScore
                            },
                        ];

                        const combinedLogs = [...(data.defectLogs || []), ...(data.weldingLogs || [])];  // ë„ì¥+ìš©ì ‘ ë¡œê·¸ í•©ì¹˜ê¸°
                        updateRealtimeCharts(data); // í¼ì„¼íŠ¸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                        updateRealtimeWarnings(data); // ìƒë‹¨ ì•Œë¦¼ì°½ ì—…ë°ì´íŠ¸
                        appendDefectLogRows(combinedLogs); // ì‹¤ì‹œê°„ ê²½ê³  ë¡œê·¸ (ë„ì¥+ìš©ì ‘)
                        updateStatusBoxes(data); // ì ê²€ ë²„íŠ¼/ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸!
                    }, 0);
                });  //
            });  //

            // ì‹¤ì‹œê°„ ë°ì´í„°ë¡œ ì°¨íŠ¸ ì¬ìƒì„±
            function updateRealtimeCharts(data) {
                const ê¸°ì¤€ê°’ = 1700;  // ìš©ì ‘ í¼ì„¼íŠ¸ ê³„ì‚°ìš©

            //  í˜ì´ì§€ì‹œì‘ ì‹œ ë¡œë”© ë©”ì‹œì§€ ì œê±° & ì°¨íŠ¸ ë³´ì—¬ì£¼ê¸°
                const castingLoading = document.getElementById('castingChartLoading');
                const castingChart = document.getElementById('castingChart');
                const weldingLoading = document.getElementById('weldingChartLoading');
                const weldingChart = document.getElementById('weldingChart');

                if (castingLoading) castingLoading.style.display = 'none';
                if (castingChart) castingChart.style.display = 'block';
                if (weldingLoading) weldingLoading.style.display = 'none';
                if (weldingChart) weldingChart.style.display = 'block';


                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ (ì°¨íŠ¸1+2)
                if (castingChartInstance) {
                    castingChartInstance.destroy();
                    castingChartInstance = null;  // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ nullë¡œ ì´ˆê¸°í™”
                }if (weldingChartInstance) {
                    weldingChartInstance.destroy();
                    weldingChartInstance = null;  // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ nullë¡œ ì´ˆê¸°í™”
                }
                // ê·¸ë¦´ ì¤€ë¹„
                const castingCanvas = document.getElementById('castingChart');
                const weldingCanvas = document.getElementById('weldingChart');
                if (!castingCanvas || !weldingCanvas) return;
                const castingCtx = castingCanvas.getContext('2d');
                const weldingCtx = weldingCanvas.getContext('2d');

                // ë°ì´í„° ê°’ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , ê°’ì´ ì—†ìœ¼ë©´ null, undefined, NaNì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ì„œ ê¸°ë³¸ê°’ 0ìœ¼ë¡œ ì²˜ë¦¬
                const castingScore = data.castingScore || 0;
                const weldingScore = data.weldingScore || 0;

                // ì°¨íŠ¸2 - ì°¨íŠ¸ ê°€ìš´ë°ê°’ ê²Œì´ì§€ % í‘œì‹œë°©ì‹
                const weldingPercent = data.weldingPercent || 0;

                // 1ë²ˆì°¨íŠ¸ ì°¨íŠ¸ìƒ‰ìƒ
                const bgColorCasting = castingScore <= 60 ? '#4CAF50' : // 1ë²ˆì°¨íŠ¸
                    castingScore <= 79 ? '#FFD700' : '#F44336';
                // 2ë²ˆì°¨íŠ¸ ì°¨íŠ¸ìƒ‰ìƒ
                const bgColorWelding = weldingPercent >= 80 ? '#F44336' :   // ğŸ”´ ìœ„í—˜
                    weldingPercent >= 61 ? '#FFD700' :   // ğŸŸ¡ ì£¼ì˜
                        '#4CAF50';                            // ğŸŸ¢ ì•ˆì •


                // --------------------------ì°¨íŠ¸ ê·¸ë¦¬ê¸°----------------------------
                // ì°¨íŠ¸1 ì ìˆ˜ í¼ì„¼íŠ¸ë¡œ í™˜ì‚° (ìµœëŒ€ 100)
                const castingPercent = Math.min(100, Math.round(data.castingScore || 0)); // í¼ì„¼íŠ¸
                // ì°¨íŠ¸1 ê·¸ë¦¬ê¸°
                castingChartInstance = new Chart(castingCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [castingPercent, 100 - castingPercent], // ì±„ìš´ë¶€ë¶„, ë¹ˆë¶€ë¶„
                            backgroundColor: [bgColorCasting, '#878787'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        circumference: 180,
                        rotation: 270,
                        cutout: '50%',
                        plugins: {
                            legend: {display: false},
                            tooltip: {enabled: false}
                        }
                    },
                    // ì°¨íŠ¸ ì¤‘ì•™ì— ì ìˆ˜ í‘œì‹œí•˜ëŠ” ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸
                    plugins: [{ // â—â—â—â— í¼ì„¼íŠ¸ í‘œì‹œ ì˜¤ë¥˜ëŠ” ì—¬ê¸°ì„œ
                        afterDraw: chart => {
                            const {ctx, chartArea: {width, height}} = chart;
                            const centerX = width / 2;
                            const centerY = height / 1.3;
                            const smallRadius = 50;

                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, smallRadius, 0, 2 * Math.PI);
                            ctx.fillStyle = '#ffffff';
                            ctx.fill();
                            ctx.strokeStyle = '#F37221';
                            ctx.lineWidth = 1;
                            ctx.stroke();
                            ctx.closePath();

                            ctx.font = '20px sans-serif';
                            ctx.fillStyle = 'black';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';

                            // â—â—â—â— í¼ì„¼íŠ¸ í‘œì‹œ (castingPercent ë³€ìˆ˜ ì‚¬ìš©)
                            ctx.fillText(`${castingPercent}%`, centerX, centerY);

                            ctx.restore();
                        }
                    }]
                });

                // ì°¨íŠ¸ 2 ê·¸ë¦¬ê¸°
                weldingChartInstance = new Chart(weldingCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [weldingPercent, 100 - weldingPercent],
                            backgroundColor: [bgColorWelding, '#878787'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        circumference: 180,
                        rotation: 270,
                        cutout: '50%',
                        plugins: {
                            legend: {display: false},
                            tooltip: {enabled: false}
                        }
                    },
                    plugins: [{ // â—â—â—â— í¼ì„¼íŠ¸ í‘œì‹œ ì˜¤ë¥˜ëŠ” ì—¬ê¸°ì„œ
                        afterDraw: chart => {
                            const {ctx, chartArea: {width, height}} = chart;
                            const centerX = width / 2;
                            const centerY = height / 1.3;
                            const smallRadius = 50;

                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, smallRadius, 0, 2 * Math.PI);
                            ctx.fillStyle = '#ffffff';
                            ctx.fill();
                            ctx.strokeStyle = '#F37221';
                            ctx.lineWidth = 1;
                            ctx.stroke();
                            ctx.closePath();

                            ctx.font = '20px sans-serif';
                            ctx.fillStyle = 'black';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${weldingPercent}%`, centerX, centerY);  // ìš©ì ‘ìš©
                            ctx.restore();
                        }
                    }]
                });
            }

            // ì—…ë°ì´íŠ¸!
            function updateStatusBoxes(data) {
                //  castingScoreì™€ weldingPercentë¥¼ ì•ˆì „í•˜ê²Œ êº¼ë‚´ê¸°
                const castingScore = Number.isFinite(data.castingScore) ? data.castingScore : 0;
                const weldingScore = Number.isFinite(data.weldingPercent) ? data.weldingPercent : 0;

                // [2] datasets ë°°ì—´ì„ ìˆœíšŒí•˜ë©´ì„œ ê° ê³µì •ë³„ ì²˜ë¦¬
                datasets.forEach(ds => {
                    const statusDiv = document.getElementById(ds.statusId);
                    if (!statusDiv) return;

                    const statusLabel = statusDiv.querySelector('.defect-label'); // ì ìˆ˜ í‘œì‹œ í…ìŠ¤íŠ¸
                    const statusButton = statusDiv.querySelector('.defect-btn');  // ì ê²€ ìš”ì²­ ë²„íŠ¼

                    //  â—â—â—â—â—â— ì°¨íŠ¸2ëŠ” Percentê°€ ì—†ê¸° ë•Œë¬¸ì— ë”°ë¡œ ì²˜ë¦¬! ì´ìƒí•œë°
                    const value = ds.msgKey === 'casting'
                        ? castingScore  // ì°¨íŠ¸1ì€ castingScore  ì§ì ‘ ì‚¬ìš©
                        : weldingScore; // ì°¨íŠ¸2ëŠ” í¼ì„¼íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©

                    const percent = Math.round(value);  // ì ìˆ˜ëŠ” 0~100 ì •ìˆ˜ë¡œ

                    // ìƒíƒœ í…ìŠ¤íŠ¸ ê°±ì‹  (ex: ì••ë ¥/ì˜¨ë„ ê°ì§€ (75%))
                    statusLabel.textContent = `${ds.label} (${percent}%)`;

                    // ì ê²€ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´: 61% ì´ìƒë§Œ ê°€ëŠ¥
                    const shouldEnable = percent >= 61;
                    statusButton.disabled = !shouldEnable;

                    // â—â—â— ê²½ê³ ì•Œë¦¼ì°½ % ì„¤ì • (ê²½ê³  ë©”ì‹œì§€ê°€ ìˆê³ , 10% ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ)
                    const warningDiv = document.getElementById(ds.warningId);
                    if (percent >= 60 && warningMessages[ds.msgKey]) {
                        warningDiv.className = 'warning-box blinking warning-placeholder';
                        warningDiv.innerHTML = `âš  ${warningMessages[ds.msgKey]}`;
                    } else {
                        warningDiv.className = 'warning-placeholder';
                        warningDiv.innerHTML = '';
                    }
                });
            }

            // ê³µì • ìµœì í™” ê¸°ì¤€ íˆ´íŒ ì¶”ê°€
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            // ì‹¤ì‹œê°„ ê²½ê³  ë©”ì‹œì§€ìš©
            const warningDatasets = [
                {warningId: "pressure-warning", msgKey: "pressure"},
                {warningId: "upperTemp-warning", msgKey: "upperTemp"},
                {warningId: "lowerTemp-warning", msgKey: "lowerTemp"},
                {warningId: "welding-warning", msgKey: "welding"}
            ];

            // ----------------------ê²½ê³  ë¡œê·¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸------------------------------
            function appendDefectLogRows(defectLogs) {
                const tbody = document.getElementById("defectLogBody");
                if (!tbody) return;
                // ê¸°ì¡´ í–‰ì„ ëª¨ë‘ ì œê±°í•˜ê³  ìƒˆë¡œ ì±„ì›Œ ë„£ëŠ” êµ¬ì¡°
                tbody.innerHTML = "";
                // ì ê²€ì™„ë£Œ(inspectionRequested=true)ëŠ” í•„í„°ë§í•´ì„œ ì œì™¸
                const filteredLogs = defectLogs.filter(log => !log.inspectionRequested);
                // ìµœì‹  10ê°œì˜ ë°ì´í„°ë¥¼ ë°˜ë³µ ì¶”ê°€
                filteredLogs.slice(-10).reverse().forEach(log => {
                    addLogToTable(log, tbody);
                });
            }

            // ìµœê·¼ ë¡œê·¸ë¥¼ ê°€ì ¸ì™€ í…Œì´ë¸”ì— ë¿Œë¦¬ëŠ” ìš©ë„
            window.addEventListener("DOMContentLoaded", () => {
                fetch("/api/recent-logs")
                    .then(res => res.json())
                    .then(data => {
                        const notInspectedLogs = data.filter(log => !log.inspectionRequested);  // ì ê²€ ì™„ë£Œ ì œì™¸
                        notInspectedLogs.forEach(log => addLogToTable(log));
                    })
                    .catch(err => console.error("ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
            });
            // ë“±ê¸‰ ìš°ì„ ìˆœìœ„ ì •ì˜
            const SEVERITY_ORDER = {
                "ğŸŸ¢ ì•ˆì •": 0,
                "ğŸŸ¡ ì£¼ì˜": 1,
                "ğŸŸ  ê²½ê³ ": 2,
                "ğŸ”´ ìœ„í—˜": 3
            };

            //  ê²½ê³ ë¡œê·¸ ì—…ë°ì´íŠ¸ ì¡°ê±´ / ì¤‘ë³µë˜ëŠ” ì¦ìƒ í•­ëª©ì´ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            function addLogToTable(log) {
                const tbody = document.querySelector("table tbody");
                const rows = tbody.querySelectorAll("tr");

                const severityRank = SEVERITY_ORDER[log.warningLevel] || 0;

                let existingRow = null;

                // 1. ê°™ì€ ì¦ìƒí•­ëª©ê³¼ ê³µì •ë‹¨ê³„ ì¡°í•©ì´ ì´ë¯¸ í…Œì´ë¸”ì— ìˆìœ¼ë©´ ì¤‘ë³µ ì²˜ë¦¬
                for (let row of rows) {
                    const rowKey = row.getAttribute("data-log-key");  // ex: "ì••ì°© ì••ë ¥_2ê³µì • - ë„ì¥"
                    const logKey = `${log.symptomItem}_${log.processStep}`; // ì§€ê¸ˆ ë“¤ì–´ì˜¨ logì˜ í‚¤
                    // ğŸ” ì½˜ì†”ì— ì°ì–´ì„œ ì§ì ‘ ë¹„êµ
                    console.log("ğŸ” ë¹„êµ ì¤‘:", {rowKey, logKey});
                    console.log("ğŸ”¥ ì¶”ê°€ í™•ì¸", {
                        symptomItem: log.symptomItem,
                        processStep: log.processStep,
                        warningLevel: log.warningLevel,
                    });
                    console.log("ğŸ”¥ ë°›ì€ ë¡œê·¸:", log);
                    if (rowKey === logKey) {
                        existingRow = row;
                        break; // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë©ˆì¶”ê¸°
                    }
                }

                // 2. ì•„ì§ ì ê²€ ìš”ì²­ ì•ˆ í–ˆê³ , ìƒˆ ë¡œê·¸ê°€ ëœ ìœ„í—˜í•˜ë‹¤ë©´ ë¬´ì‹œ
                if (existingRow) {
                    const existingSeverityLabel = existingRow.getAttribute("data-warning-level");
                    const existingInspection = existingRow.getAttribute("data-inspection-requested") === "true";
                    const existingRank = SEVERITY_ORDER[existingSeverityLabel] || 0;

                    // ì ê²€ ì „ì´ê³ , ê¸°ì¡´ë³´ë‹¤ ê²½ê³  ë ˆë²¨ì´ ë‚®ìœ¼ë©´ â†’ ë¬´ì‹œ
                    if (!existingInspection && severityRank <= existingRank) {
                        console.log(`âš  ë¬´ì‹œ: ê¸°ì¡´ë³´ë‹¤ ì‹¬ê°ë„ ë‚®ìŒ (${log.symptomItem})`);
                        return;
                    }
                    // ë“±ê¸‰ ìƒìŠ¹ì´ê±°ë‚˜ ì ê²€ ì™„ë£Œ í›„ë¼ë©´ â†’ ê¸°ì¡´ í–‰ ì œê±°í•˜ê³  ìƒˆë¡œ ì¶”ê°€
                    tbody.removeChild(existingRow);
                }

                // 3. ìƒˆ í–‰ ìƒì„± ë° ì¶”ê°€ tr.innerHTML ë¶€ë¶„
                const isNormal = log.warningLevel.includes("ì•ˆì •");

                const tr = document.createElement("tr");
                tr.setAttribute("data-symptom-item", log.symptomItem);
                tr.setAttribute("data-warning-level", log.warningLevel);
                tr.setAttribute("data-inspection-requested", log.inspectionRequested);
                tr.setAttribute("data-log-key", `${log.symptomItem}_${log.processStep}`); // 2ë²ˆì°¨íŠ¸
                tr.innerHTML = `
                <td>${log.timestamp}</td>
                <td>${log.processStep}</td>
                <td>${log.symptomItem}</td>
                <td>${log.symptom}</td>
                <td>${log.score}</td>
                <td>${log.warningLevel}</td>
                <td>
                    ${log.inspectionRequested
                    ? "ì ê²€ì™„ë£Œ"
                    : isNormal
                        ? `<button class="status-btn" disabled style="background-color:#ccc; color:white;">ì ê²€ìš”ì²­</button>`
                        : `<button class="status-btn"
                   onclick="requestInspection('${log.symptomItem}')"
                   style="background-color:#FF5900; color:white;">ì ê²€ìš”ì²­</button>`}
                </td>
                    `;
                tbody.prepend(tr);  // ìµœì‹  í•­ëª©ì„ ë§¨ ìœ„ë¡œ!
            }

            // ì ê²€ìš”ì²­ë²„íŠ¼ -> ëª¨ë‹¬ì—´ê¸° ì „ìš©
            function requestInspection(symptom) {
                document.getElementById("confirmModalSymptom").innerText = symptom;
                selectedSymptomForDelete = symptom;

                const modalEl = document.getElementById("confirmModal");
                let modal = bootstrap.Modal.getInstance(modalEl);
                if (!modal) {
                    modal = new bootstrap.Modal(modalEl);
                }
                modal.show();
            }

            // ì ê²€ìš”ì²­ë²„íŠ¼ -> ëª¨ë‹¬ë‹«ê¸° ì „ìš©
            window.confirmDelete = function () {
                const symptomText = document.getElementById("confirmModalSymptom").innerText;
                const modalBody = document.querySelector("#confirmModal .modal-body");
                const modalFooter = document.querySelector("#confirmModal .modal-footer");

                // ë°”ë”” êµì²´
                modalBody.innerHTML = `
                <p class="fw-bold text-center mb-2">${symptomText}</p>
                <p class="text-center" style="color: #FF6A00">ì ê²€ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            `;
                // [í™•ì¸] ë²„íŠ¼ë§Œ ë‚¨ê¸°ê¸°
                modalFooter.innerHTML = `
                <button type="button"
                        class="btn btn-danger"
                        style="background-color: #FF6A00; color: white;"
                        data-bs-dismiss="modal">í™•ì¸
                </button>
            `;
            };

            function openDeleteModal(symptom) {
                selectedSymptomForDelete = symptom;
                const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
                modal.show();
            }

            //  ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë°›ì•„ì„œ DOMì„ ì—…ë°ì´íŠ¸ (ì°¨íŠ¸ ê²½ê³  í‘œì‹œìš©)
            function updateRealtimeWarnings(data) {

                // 1. ì°¨íŠ¸ ìƒë‹¨ ê²½ê³ ì°½ ê°±ì‹  ( ê²½ê³ ë©”ì‹œì§€ ë¶€ë¶„)
                datasets.forEach(ds => {
                    const elem = document.getElementById(ds.warningId); // ê²½ê³  ë©”ì‹œì§€ ìœ„ì¹˜ div
                    const warning = data[`${ds.msgKey}Warning`];        // Flaskì—ì„œ ë°›ì€ ê²½ê³  ë©”ì‹œì§€
                    const score = data[`${ds.msgKey}Score`] || 0;       // ì ìˆ˜: í¼ì„¼íŠ¸ ë‹¨ìœ„ë¡œ ë°›ì€ ìˆ˜ì¹˜

                    //  ì ìˆ˜ê°€ 61 ì´ìƒì´ê³ , ê²½ê³  ë©”ì‹œì§€ê°€ ìˆì„ ë•Œë§Œ ê²½ê³  í‘œì‹œ!
                    if (warning === "ì•ˆì •" || !warning) {
                        // ğŸ‘‰ ì•ˆì • ë©”ì‹œì§€ê±°ë‚˜ ê²½ê³  ë©”ì‹œì§€ ìì²´ê°€ ì—†ì„ ê²½ìš°
                        elem.innerHTML = '';  // ë©”ì‹œì§€ ë¹„ìš°ê¸°
                        elem.classList.remove('warning-box', 'blinking');  // ê²½ê³  ìŠ¤íƒ€ì¼ ì œê±°
                    } else if (score >= 61) {
                        // ğŸ‘‰ ê²½ê³  ë©”ì‹œì§€ê°€ ìˆê³ , ì ìˆ˜ë„ 61 ì´ìƒì¼ ë•Œë§Œ!
                        elem.innerHTML = `âš  ${warning}`;  // ê²½ê³  í‘œì‹œ
                        elem.classList.add('warning-box', 'blinking');  // ìŠ¤íƒ€ì¼ ì ìš©
                    }
                });

                // 2. ì„¸ë¶€ í•­ëª©(ì••ë ¥/ì˜¨ë„/ìš©ì ‘)ë³„ ê²½ê³  ë©”ì‹œì§€ ì²˜ë¦¬
                warningDatasets.forEach(ds => {
                    const elem = document.getElementById(ds.warningId);
                    const warning = data[`${ds.msgKey}Warning`];
                    const score = data[`${ds.msgKey}Score`] || 0;

                    // âš ï¸ ì„¸ë¶€í•­ëª©ë„ ë™ì¼í•˜ê²Œ: 61 ì´ìƒ + ê²½ê³  ë©”ì‹œì§€ ìˆì„ ë•Œë§Œ í‘œì‹œ
                    if (elem && score >= 61 && warning && warning !== "ì•ˆì •") {
                        elem.innerHTML = `âš  ${warning}`;
                        elem.classList.add('warning-box', 'blinking');
                    } else if (elem) {
                        elem.innerHTML = '';
                        elem.classList.remove('warning-box', 'blinking');
                    }
                });
            }
        });
    </script>
</th:block>
</html>
