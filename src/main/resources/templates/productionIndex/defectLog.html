<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<th:block layout:fragment="content">
    <div class="py-4">
        <!-- ì„œë¸Œíƒ€ì´í‹€ -->
        <div class="subtitle_css"><i class="bi bi-activity"></i> ìƒì‚°ì§€í‘œê´€ë¦¬_ë¶ˆëŸ‰ì˜ˆì¸¡</div>
        <div class="fw-bold py-3">ê¸°ê³„ ì´ìƒ ê°ì§€</div>

        <!-- ì£¼ì¡° ê³µì • -->
        <div class="row justify-content-center">
            <div class="col-lg-6 col-12 text-center">
                <!-- ê²½ê³  ë©”ì‹œì§€ ìœ„ì¹˜ (ë†’ì´ ê³ ì •) -->
                <div id="castingWarning" class="warning-placeholder">
                    <div th:if="${castingWarningMsg != ''}" class="alert alert-warning" style="font-weight: bold;">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span th:text="${castingWarningMsg}"></span>
                    </div>
                </div>
                <div style="display: block; width: 70%; margin: 0 auto; padding: 0;">
                    <canvas id="castingChart"
                            role="img"
                            aria-label="ì£¼ì¡° ê³µì • ì•ˆì •ì„± ì°¨íŠ¸"
                            style="display: block; width: 100%; max-height: 300px; margin-bottom: 0;"></canvas>
                    <div id="castingStatus" class="d-flex justify-content-between align-items-center" style="margin-top: 0; padding-top: 0;">
                        <div class="defect-box">
                            <span class="defect-label defect-tooltip"
                                  data-bs-toggle="tooltip"
                                  data-bs-placement="top"
                                  data-bs-html="true"
                                  title="<b>2ê³µì • (ë„ì¥) ìµœì í™” ê¸°ì¤€</b><br>
                                        - ì••ì°© ì••ë ¥ 299 ì´ìƒ
                                        - ìƒë‹¨ ê¸ˆí˜• ì˜¨ë„ 94â„ƒ ì´ìƒ
                                        - í•˜í–¥ ê¸ˆí˜• ì˜¨ë„ 193â„ƒ ì´ìƒ">
                                          ì••ë ¥/ì˜¨ë„ ê°ì§€
                                        </span>
                            <button type="button" class="defect-btn" style="background-color: #A0A0A0;" disabled>ì ê²€ìš”ì²­</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìš©ì ‘ ê³µì • -->
            <div class="col-lg-6 col-12 text-center">
                <div id="weldingWarning" class="warning-placeholder"></div>
                <div style="display: block; width: 70%; margin: 0 auto; padding: 0;">
                    <canvas id="weldingChart"
                            role="img"
                            aria-label="ìš©ì ‘ ê³µì • ì•ˆì •ì„± ì°¨íŠ¸"
                            style="display: block; width: 100%; max-height: 300px; margin-bottom: 0;"></canvas>
                    <div id="weldingStatus" class="d-flex justify-content-between align-items-center" style="margin-top: 0; padding-top: 0;">
                        <div class="defect-box">
                            <span class="defect-label">ìš©ì ‘ ì¶œë ¥ ê°ì§€ (0%)</span>
                            <button type="button" class="defect-btn" style="background-color: #A0A0A0;" disabled>ì ê²€ìš”ì²­</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê²½ê³  ë¡œê·¸ í…Œì´ë¸”-->
        <div class="py-3 fw-bold">ê²½ê³  ë¡œê·¸</div>
        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle table1_css">
                <thead>
                <tr>
                    <th class="col-small">ë°œìƒì¼ì‹œ</th>
                    <th class="col-small">ë°œìƒê³µì •</th>
                    <th class="col-large">ê°ì§€í˜„ìƒ</th>
                    <th>í™•ì¸</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="log : ${defectLogs}">
                    <td th:text="${#temporals.format(log.detectedAt, 'yyyy.MM.dd HH:mm')}">ë‚ ì§œì‹œê°„</td>
                    <td th:text="${log.processStep}">ê³µì •ëª…</td>
                    <td th:text="${log.symptom}">
                        <span th:if="${log.symptom == 'ì••ì°© ì••ë ¥ ê¸°ì¤€ ë¯¸ë‹¬'}">ì••ì°© ì••ë ¥ ê¸°ì¤€ ë¯¸ë‹¬</span>
                        <span th:if="${log.symptom == 'ìƒë‹¨ ê¸ˆí˜• ì˜¨ë„ ê¸°ì¤€ ë¯¸ë‹¬'}">ìƒë‹¨ ê¸ˆí˜• ì˜¨ë„ ê¸°ì¤€ ë¯¸ë‹¬</span>
                        <span th:if="${log.symptom == 'í•˜í–¥ ê¸ˆí˜• ì˜¨ë„ ê¸°ì¤€ ë¯¸ë‹¬'}">í•˜í–¥ ê¸ˆí˜• ì˜¨ë„ ê¸°ì¤€ ë¯¸ë‹¬</span>
                        <span th:if="${log.symptom == 'ìš©ì ‘ ì¶œë ¥ ì´ìƒ'}">ìš©ì ‘ ì¶œë ¥ ì´ìƒ</span>
                    </td>
                    <td>
                        <form th:action="@{/indicators/defect-predict/inspect}" method="post">
                            <input type="hidden" name="detectedAt" th:value="${log.detectedAt}" />
                            <button type="submit"
                                    th:text="${log.inspectionRequested ? 'í™•ì¸ì™„ë£Œ' : 'ì ê²€ìš”ì²­'}"
                                    th:disabled="${log.inspectionRequested}"
                                    th:attr="style=${log.inspectionRequested} ? 'background-color:#878787 !important; color:white !important;' : 'background-color:#FF5900 !important; color:black !important;'"
                                    class="status-btn status-unchecked">
                            </button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ì°¨íŠ¸ 2ê°œ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript" layout:fragment="script">

        const castingScore = /*[[${castingScore}]]*/ 0;
        const weldingScore = /*[[${weldingScore}]]*/ 0;

        // íƒ€ì„ë¦¬í”„ì—ì„œ ë°›ì€ ê²½ê³  ë©”ì‹œì§€ ë°”ì¸ë”©
        const warningMessages = {
            casting: '[[${castingWarningMsg}]]',
            welding: '[[${weldingWarningMsg}]]'
        };

        document.addEventListener('DOMContentLoaded', function () {

            // ğŸ•’ WebSocket ìˆ˜ì‹  ì¶”ê°€
            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);

            let castingChartInstance = null;
            let weldingChartInstance = null;

            stompClient.connect({}, () => {
                stompClient.subscribe('/topic/defect', function (message) {
                    const data = JSON.parse(message.body);
                    console.log("ğŸ“¢ ì‹¤ì‹œê°„ ì˜ˆì¸¡ ë„ì°©:", data);
                    console.log("Casting Score:", data.castingScore);  // 0~100 ì¸ì§€ í™•ì¸
                    console.log("Casting Data ë°°ì—´:", [data.castingScore, 100 - data.castingScore]);

                    // ë°ì´í„°ê°€ ìœ íš¨í•œì§€ ì²´í¬ í›„ ì—…ë°ì´íŠ¸
                    if (!data.castingScore || isNaN(data.castingScore)) {
                        data.castingScore = 0;  // ê¸°ë³¸ê°’ ì„¤ì •
                    }
                    if (!data.weldingScore || isNaN(data.weldingScore)) {
                        data.weldingScore = 0;  // ê¸°ë³¸ê°’ ì„¤ì •
                    }

                    setTimeout(() => {
                        updateRealtimeCharts(data);
                        updateRealtimeWarnings(data);
                    }, 0);  // setTimeout ë
                });  // stompClient.subscribe ë
            });  // stompClient.connect ë

            // ì‹¤ì‹œê°„ ì°¨íŠ¸ ë°˜ì˜ í•¨ìˆ˜
            function updateRealtimeCharts(data) {
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
                if (castingChartInstance) {
                    castingChartInstance.destroy();
                    castingChartInstance = null;  // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ nullë¡œ ì´ˆê¸°í™”
                }

                const castingCanvas = document.getElementById('castingChart');
                const weldingCanvas = document.getElementById('weldingChart');
                if (!castingCanvas || !weldingCanvas) return;

                const castingCtx = castingCanvas.getContext('2d');
                const weldingCtx = weldingCanvas.getContext('2d');

                // ë°ì´í„° ê°’ì´ ìœ íš¨í•œì§€ í™•ì¸í•˜ê³ , ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                const castingScore = data.castingScore || 0;
                const weldingScore = data.weldingScore || 0;

                // ìƒ‰ìƒ êµ¬ê°„: green(ì•ˆì •) / yellow(ì£¼ì˜) / red(ìœ„í—˜)
                let bgColorCasting = castingScore <= 60 ? '#4CAF50' : castingScore <= 79 ? '#FFD700' : '#F44336';
                let bgColorWelding = weldingScore <= 60 ? '#4CAF50' : weldingScore <= 79 ? '#FFD700' : '#F44336';;

                // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                castingChartInstance = new Chart(castingCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [castingScore, 100 - castingScore],
                            backgroundColor: [bgColorCasting, '#878787'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        circumference: 180,
                        rotation: 270,
                        cutout: '50%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    },
                    plugins: [{
                        afterDraw: chart => {
                            const { ctx, chartArea: { width, height } } = chart;
                            const centerX = width / 2;
                            const centerY = height / 1.3;
                            const smallRadius = 50;

                            ctx.save();
                            ctx.beginPath();
                            ctx.arc(centerX, centerY, smallRadius, 0, 2 * Math.PI);
                            ctx.fillStyle = '#ffffff';
                            ctx.fill();
                            ctx.strokeStyle = '#F37221';
                            ctx.lineWidth = 1;
                            ctx.stroke();
                            ctx.closePath();

                            ctx.font = '20px sans-serif';
                            ctx.fillStyle = 'black';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(`${Math.round(castingScore)}%`, centerX, centerY);  // í¼ì„¼íŠ¸ í‘œì‹œ
                            ctx.restore();
                        }
                    }]
                });

                // ìš©ì ‘ ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                weldingChartInstance = new Chart(weldingCtx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [weldingScore, 100 - weldingScore],
                            backgroundColor: [bgColorWelding, '#878787'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        circumference: 180,
                        rotation: 270,
                        cutout: '50%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    }
                });
            }

            // ê¸°ì¡´ welding ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
            if (weldingChartInstance) {
                weldingChartInstance.destroy();
                weldingChartInstance = null;     // ì¸ìŠ¤í„´ìŠ¤ë¥¼ nullë¡œ ì´ˆê¸°í™”
            }
            const weldingCtx = document.getElementById('weldingChart').getContext('2d');
            weldingChartInstance = new Chart(weldingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['OK', 'NG'],
                    datasets: [{
                        data: [data.weldingScore, 100 - data.weldingScore],
                        backgroundColor: ['#4CAF50', '#F44336'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    cutout: '50%',
                    plugins: {
                        legend: {display: false},
                        tooltip: {enabled: false}
                    }
                }
            });

            // ì‹¤ì‹œê°„ ê²½ê³ ì°½ ë°˜ì˜ í•¨ìˆ˜
            function updateRealtimeWarnings(data) {
                const castingWarningDiv = document.getElementById('castingWarning');
                const weldingWarningDiv = document.getElementById('weldingWarning');

                // castingWarningì´ ì¡´ì¬í•˜ë©´
                if (data.castingWarning) {
                    // ê¸°ì¡´ ê²½ê³  ë©”ì‹œì§€ì— ìƒˆë¡œìš´ ê²½ê³  ë©”ì‹œì§€ë¥¼ ì¶”ê°€ (ëˆ„ì )
                    castingWarningDiv.innerHTML += `<p>âš  ${data.castingWarning}</p>`;
                    castingWarningDiv.classList.add('warning-box'); // ê²½ê³  ìŠ¤íƒ€ì¼ì„ ì¶”ê°€
                }

                // weldingWarningì´ ì¡´ì¬í•˜ë©´
                if (data.weldingWarning) {
                    // ê¸°ì¡´ ê²½ê³  ë©”ì‹œì§€ì— ìƒˆë¡œìš´ ê²½ê³  ë©”ì‹œì§€ë¥¼ ì¶”ê°€ (ëˆ„ì )
                    weldingWarningDiv.innerHTML += `<p>âš  ${data.weldingWarning}</p>`;
                    weldingWarningDiv.classList.add('warning-box'); // ê²½ê³  ìŠ¤íƒ€ì¼ì„ ì¶”ê°€
                }
            }

            // ê³µì • ìµœì í™” ê¸°ì¤€ íˆ´íŒ ì¶”ê°€
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            const datasets = [
                {
                    id: 'castingChart',
                    statusId: 'castingStatus',
                    warningId: 'castingWarning',
                    msgKey: 'casting',
                    label: 'ì••ë ¥/ì˜¨ë„ ê°ì§€',
                    value: castingScore
                },
                {
                    id: 'weldingChart',
                    statusId: 'weldingStatus',
                    warningId: 'weldingWarning',
                    msgKey: 'welding',
                    label: 'ìš©ì ‘ ì¶œë ¥ ê°ì§€',
                    value: weldingScore
                }
            ];

            // datasets.forEachëŠ” ì²˜ìŒ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ ì²˜ë¦¬
            datasets.forEach(data => {
                if (document.getElementById(data.id)) {
                    const ctx = document.getElementById(data.id).getContext('2d');
                    // ì´ˆê¸° ì°¨íŠ¸ ìƒì„±
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [data.value, 100 - data.value],
                                backgroundColor: [data.value <= 60 ? 'green' : data.value <= 79 ? '#FFD700' : 'red', '#878787'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            responsive: true,
                            circumference: 180,
                            rotation: 270,
                            cutout: '50%',
                            plugins: {
                                legend: {display: false},
                                tooltip: {enabled: false}
                            }
                        },
                        plugins: [{
                            afterDraw: chart => {
                                const {ctx, chartArea: {width, height}} = chart;
                                const centerX = width / 2;
                                const centerY = height / 1.3;
                                const smallRadius = 50;

                                ctx.save();
                                ctx.beginPath();
                                ctx.arc(centerX, centerY, smallRadius, 0, 2 * Math.PI);
                                ctx.fillStyle = '#ffffff';
                                ctx.fill();
                                ctx.strokeStyle = '#F37221';
                                ctx.lineWidth = 1;
                                ctx.stroke();
                                ctx.closePath();

                                ctx.font = '20px sans-serif';
                                ctx.fillStyle = 'black';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(`${Math.round(data.value)}%`, centerX, centerY);
                                ctx.restore();
                            }
                        }]
                    });
                }
            });

            // ìƒíƒœ í…ìŠ¤íŠ¸ ë° ë²„íŠ¼ í™œì„±í™” ì²˜ë¦¬
            const statusDiv = document.getElementById(data.statusId);
            const statusLabel = statusDiv.querySelector('.defect-label');
            const statusButton = statusDiv.querySelector('.defect-btn');

            statusLabel.textContent = `${data.label} (${Number(data.value).toFixed(0)}%)`;
            statusButton.disabled = data.value < 80;

            // ê²½ê³  ë©”ì‹œì§€ ì²˜ë¦¬
            const warningDiv = document.getElementById(data.warningId);
            if (data.value >= 80) {
                warningDiv.className = 'warning-box blinking warning-placeholder';
                warningDiv.innerHTML = `âš  ${warningMessages[data.msgKey]}`;
            } else {
                warningDiv.className = 'warning-placeholder';
                warningDiv.innerHTML = '';
            }
        });
    </script>
</th:block>
</html>
